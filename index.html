<!--
LBM (Leaflet Blog Manager)
Version: 0.1
License: MIT
applchu wuz here
-->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Loading...</title>
    <!-- MODULE: LIBRARIES -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        .delete-btn {
            background: none;
            border: none;
            color: var(--dislike-color);
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            opacity: 0.7;
            margin-left: auto; /* Pushes to right */
        }
        .delete-btn:hover { opacity: 1; text-decoration: underline; }
    </style>
</head>

<body>

    <!-- MODULE: SETUP WIZARD -->
    <div id="setup-overlay" style="display:none;">
        <div class="setup-box">
            <h1 style="color:var(--accent-color); margin-bottom:20px; text-align:center;">SYSTEM BOOT // INITIAL SETUP</h1>

            <h3 style="border-bottom:1px dotted #555; margin-bottom:10px;">1. Connectivity & Security</h3>
            <label style="font-size:11px; color:#aaa;">Firebase Config (From Console):</label>
            <textarea id="setup-config-text" class="setup-input" rows="4" placeholder='const firebaseConfig = { ... };'></textarea>

            <label style="font-size:11px; color:#aaa; margin-top:10px;">Create Admin Password:</label>
            <input type="password" id="setup-password" class="setup-input" placeholder="Password">

            <h3 style="border-bottom:1px dotted #555; margin: 20px 0 10px 0;">2. Identity & Branding</h3>
            <div class="config-grid">
                <div class="config-item">
                    <label>Site Name</label>
                    <input type="text" id="setup-site-name" class="setup-input" value="LBM // System" oninput="updateSetupPreview()">
                </div>
                <div class="config-item">
                    <label>Tagline</label>
                    <input type="text" id="setup-tagline" class="setup-input" value="Personal Archive" oninput="updateSetupPreview()">
                </div>
                <div class="config-item">
                    <label>Leaflets Tab Name</label>
                    <input type="text" id="setup-leaflets-name" class="setup-input" value="Leaflets" oninput="updateSetupPreview()">
                </div>
                <div class="config-item">
                    <label>Copyright</label>
                    <input type="text" id="setup-copyright" class="setup-input" value="2025 LBM" oninput="updateSetupPreview()">
                </div>
            </div>

            <div class="config-item" style="margin-bottom:10px;">
                <label>Profile Picture URL</label>
                <input type="text" id="setup-pfp-image" class="setup-input" placeholder="https://..." oninput="updateSetupPreview()">
            </div>
            <div class="config-item" style="margin-bottom:10px;">
                <label>Header Banner URL</label>
                <input type="text" id="setup-banner-image" class="setup-input" placeholder="https://..." oninput="updateSetupPreview()">
            </div>

            <h3 style="border-bottom:1px dotted #555; margin: 20px 0 10px 0;">3. Theme & Colors</h3>
            <div class="config-grid">
                <div class="config-item">
                    <label>Main Background</label>
                    <input type="color" id="col-bg" class="color-picker" value="#2B2B2B" oninput="updateSetupPreview()">
                </div>
                <div class="config-item">
                    <label>Text Color</label>
                    <input type="color" id="col-text" class="color-picker" value="#F0FFF0" oninput="updateSetupPreview()">
                </div>
                <div class="config-item">
                    <label>Sidebar/Footer</label>
                    <input type="color" id="col-sidebar" class="color-picker" value="#3B3B3B" oninput="updateSetupPreview()">
                </div>
                <div class="config-item">
                    <label>Accent Color</label>
                    <input type="color" id="col-accent" class="color-picker" value="#76c7c0" oninput="updateSetupPreview()">
                </div>
                <div class="config-item">
                    <label>Post Background</label>
                    <input type="color" id="col-leaflet" class="color-picker" value="#353535" oninput="updateSetupPreview()">
                </div>
                <div class="config-item">
                    <label>Borders</label>
                    <input type="color" id="col-border" class="color-picker" value="#555555" oninput="updateSetupPreview()">
                </div>
                <div class="config-item">
                    <label>Active Nav Text</label>
                    <input type="color" id="col-nav-active" class="color-picker" value="#FFFFFF" oninput="updateSetupPreview()">
                </div>
            </div>

            <h4 style="margin: 10px 0 5px 0; color: #aaa; border-bottom: 1px dotted #555;">Reaction Widget</h4>
            <div class="config-grid">
                <div class="config-item">
                    <label>Enable Reactions?</label>
                    <select id="setup-reactions-enabled" class="setup-input" onchange="updateSetupPreview()">
                        <option value="true">Yes</option>
                        <option value="false">No</option>
                    </select>
                </div>
                <div class="config-item">
                    <label>Icon Style</label>
                    <select id="setup-reaction-icon" class="setup-input" onchange="updateSetupPreview()">
                        <option value="face">Faces (^_^)</option>
                        <option value="thumb">Thumbs üëç</option>
                        <option value="arrow">Arrows ‚¨Ü</option>
                    </select>
                </div>
                <div class="config-item">
                    <label>Like Label</label>
                    <input type="text" id="setup-like-label" class="setup-input" value="(Ôºæ‚àáÔºæ)" oninput="updateSetupPreview()">
                </div>
                <div class="config-item">
                    <label>Dislike Label</label>
                    <input type="text" id="setup-dislike-label" class="setup-input" value="(Ôºõ„Å∏Ôºö)" oninput="updateSetupPreview()">
                </div>
            </div>
            <div class="config-grid">
                <div class="config-item">
                    <label>Like Meter Color</label>
                    <input type="color" id="col-like" class="color-picker" value="#76c7c0" oninput="updateSetupPreview()">
                </div>
                <div class="config-item">
                    <label>Dislike Meter Color</label>
                    <input type="color" id="col-dislike" class="color-picker" value="#ff7675" oninput="updateSetupPreview()">
                </div>
                <div class="config-item">
                    <label>Like Button Text</label>
                    <input type="color" id="col-like-btn" class="color-picker" value="#F0FFF0" oninput="updateSetupPreview()">
                </div>
                <div class="config-item">
                    <label>Dislike Button Text</label>
                    <input type="color" id="col-dislike-btn" class="color-picker" value="#F0FFF0" oninput="updateSetupPreview()">
                </div>
            </div>
            <div class="config-item" style="margin-bottom:10px;">
                <label>Widget Padding</label>
                <input type="text" id="setup-widget-padding" class="setup-input" value="10px" oninput="updateSetupPreview()">
            </div>

            <div class="config-item" style="margin-bottom:10px;">
                <label>Global Background Image (Optional)</label>
                <input type="text" id="setup-bg-image" class="setup-input" placeholder="https://..." oninput="updateSetupPreview()">
            </div>

            <div class="config-item">
                <label>Allow Comments?</label>
                <select id="setup-comments" class="setup-input" onchange="updateSetupPreview()">
                    <option value="true">Yes</option>
                    <option value="false">No</option>
                </select>
            </div>

            <h3 style="border-bottom:1px dotted #555; margin: 20px 0 10px 0;">4. Advanced</h3>
            <div class="config-item">
                <label>Custom CSS (Overrides style.css)</label>
                <textarea id="setup-custom-css" class="setup-input" rows="4" placeholder="body { font-family: 'Arial'; }" oninput="updateSetupPreview()"></textarea>
            </div>

            <button class="action-btn" onclick="generateConfigFile('setup')" style="margin-top:20px;">GENERATE system.js</button>
            <p style="font-size:11px; color:#666; margin-top:10px; text-align:center;">
                This will download 'system.js'. Upload it to your site folder to launch.
            </p>
        </div>
    </div>

    <div class="container">
        <header id="site-header-block">
            <div class="header-overlay">
                <div class="header-row">
                    <div class="header-identity">
                        <img id="header-pfp" class="site-pfp" alt="PFP">
                        <div class="header-titles">
                            <h1 id="header-site-name">Loading...</h1>
                            <div id="header-tagline" class="site-tagline"></div>
                        </div>
                    </div>
                    <div id="db-status">Initializing System...</div>
                </div>
            </div>
        </header>

        <div class="layout-wrapper">
            <nav class="sidebar">
                <button class="nav-btn active" onclick="switchTab('leaflets')" id="nav-leaflets-btn">Leaflets</button>
                <button class="nav-btn" onclick="switchTab('gallery')">Gallery</button>
                <div style="height: 10px;"></div>
                <button class="nav-btn" id="admin-tab-btn" onclick="switchTab('admin')" style="color: #888; border-color: #444;">Login</button>
            </nav>

            <main>
                <!-- MODULE: FEED -->
                <section id="tab-leaflets" class="view-section active">
                    <h2 id="header-leaflets-title">Recent Updates</h2>
                    <div id="leaflets-container">Loading...</div>
                </section>

                <!-- MODULE: GALLERY -->
                <section id="tab-gallery" class="view-section">
                    <h2>Image Gallery</h2>
                    <div id="gallery-container" class="gallery-grid">Loading...</div>
                </section>

                <!-- MODULE: ADMIN -->
                <section id="tab-admin" class="view-section">
                    <h2>Admin // Login</h2>

                    <div id="admin-login-form" class="admin-panel">
                        <p style="margin-bottom:15px; color:#aaa;">Enter your admin password to access posting and site settings.</p>
                        <input type="password" id="login-pass" class="setup-input" placeholder="Password" style="margin-bottom:10px;">
                        <button class="action-btn" onclick="adminLogin()">Access System</button>
                    </div>

                    <div id="admin-dashboard" style="display:none;">
                        <div style="display:flex; gap:10px; margin-bottom:15px;">
                            <button class="action-btn" onclick="switchAdminSubTab('post')" style="flex:1;">New Post</button>
                            <button class="action-btn" onclick="switchAdminSubTab('settings')" style="flex:1; background:#444;">Site Settings</button>
                            <button class="action-btn" onclick="location.reload()" style="flex:0; background:#ff7675;">Logout</button>
                        </div>

                        <div id="admin-sub-post" class="admin-panel">
                            <h3>Create New Content</h3>
                            <p style="font-size:11px; color:#aaa; margin-bottom:5px;">Markdown is supported! (**bold**, *italic*, [link](url))</p>
                            <div class="form-group" style="margin-bottom: 15px;">
                                <textarea id="admin-content" rows="4" placeholder="What's on your mind?" style="width:100%; padding:8px; background:#222; color:#fff; border:1px solid #555;"></textarea>
                            </div>
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="color:var(--accent-color); display:block; margin-bottom:5px;">Media Upload (Generate Path)</label>
                                <div class="file-upload-wrapper">
                                    <input type="file" id="file-selector" onchange="handleFileSelect()" accept="image/*,video/*">
                                    <img id="upload-preview" class="preview-thumb">
                                </div>
                            </div>
                            <div class="form-group" style="margin-bottom: 15px;">
                                <input type="text" id="admin-media" placeholder="Media Path (e.g. img/photo.jpg)" style="width:100%; padding:8px; background:#222; color:#fff; border:1px solid #555;">
                            </div>
                            <button class="action-btn" onclick="addPost()">Post to Database</button>
                        </div>

                        <div id="admin-sub-settings" class="admin-panel" style="display:none;">
                            <h3>Customize Site Design</h3>
                            <p style="font-size:11px; color:#aaa; margin-bottom:15px;">Changes you make here will appear <strong>instantly</strong>. Click Export to save them permanently.</p>

                            <div class="config-grid">
                                <div class="config-item">
                                    <label>Site Name</label>
                                    <input type="text" id="edit-site-name" class="setup-input" oninput="updateLivePreview()">
                                </div>
                                <div class="config-item">
                                    <label>Tagline</label>
                                    <input type="text" id="edit-tagline" class="setup-input" oninput="updateLivePreview()">
                                </div>
                                <div class="config-item">
                                    <label>Leaflets Tab Name</label>
                                    <input type="text" id="edit-leaflets-name" class="setup-input" oninput="updateLivePreview()">
                                </div>
                                <div class="config-item">
                                    <label>Copyright</label>
                                    <input type="text" id="edit-copyright" class="setup-input" oninput="updateLivePreview()">
                                </div>
                            </div>

                            <div class="config-grid">
                                <div class="config-item">
                                    <label>PFP URL</label>
                                    <input type="text" id="edit-pfp-image" class="setup-input" oninput="updateLivePreview()">
                                </div>
                                <div class="config-item">
                                    <label>Banner URL</label>
                                    <input type="text" id="edit-banner-image" class="setup-input" oninput="updateLivePreview()">
                                </div>
                            </div>

                            <h4>Colors & Theme</h4>
                            <div class="config-grid">
                                <div class="config-item">
                                    <label>Background</label>
                                    <input type="color" id="edit-col-bg" class="color-picker" oninput="updateLivePreview()">
                                </div>
                                <div class="config-item">
                                    <label>Text</label>
                                    <input type="color" id="edit-col-text" class="color-picker" oninput="updateLivePreview()">
                                </div>
                                <div class="config-item">
                                    <label>Sidebar/Footer</label>
                                    <input type="color" id="edit-col-sidebar" class="color-picker" oninput="updateLivePreview()">
                                </div>
                                <div class="config-item">
                                    <label>Accent</label>
                                    <input type="color" id="edit-col-accent" class="color-picker" oninput="updateLivePreview()">
                                </div>
                                <div class="config-item">
                                    <label>Post Bg</label>
                                    <input type="color" id="edit-col-leaflet" class="color-picker" oninput="updateLivePreview()">
                                </div>
                                <div class="config-item">
                                    <label>Borders</label>
                                    <input type="color" id="edit-col-border" class="color-picker" oninput="updateLivePreview()">
                                </div>
                                <div class="config-item">
                                    <label>Active Nav Text</label>
                                    <input type="color" id="edit-col-nav-active" class="color-picker" oninput="updateLivePreview()">
                                </div>
                            </div>

                            <h4>Reaction Settings</h4>
                            <div class="config-grid">
                                <div class="config-item">
                                    <label>Enable?</label>
                                    <select id="edit-reactions-enabled" class="setup-input" onchange="updateLivePreview()">
                                        <option value="true">Yes</option>
                                        <option value="false">No</option>
                                    </select>
                                </div>
                                <div class="config-item">
                                    <label>Icon Style</label>
                                    <select id="edit-reaction-icon" class="setup-input" onchange="updateLivePreview()">
                                        <option value="face">Faces (^_^)</option>
                                        <option value="thumb">Thumbs üëç</option>
                                        <option value="arrow">Arrows ‚¨Ü</option>
                                    </select>
                                </div>
                                <div class="config-item">
                                    <label>Like Label</label>
                                    <input type="text" id="edit-like-label" class="setup-input" oninput="updateLivePreview()">
                                </div>
                                <div class="config-item">
                                    <label>Dislike Label</label>
                                    <input type="text" id="edit-dislike-label" class="setup-input" oninput="updateLivePreview()">
                                </div>
                            </div>
                            <div class="config-grid">
                                <div class="config-item">
                                    <label>Like Meter</label>
                                    <input type="color" id="edit-col-like" class="color-picker" oninput="updateLivePreview()">
                                </div>
                                <div class="config-item">
                                    <label>Dislike Meter</label>
                                    <input type="color" id="edit-col-dislike" class="color-picker" oninput="updateLivePreview()">
                                </div>
                                <div class="config-item">
                                    <label>Like Text</label>
                                    <input type="color" id="edit-col-like-btn" class="color-picker" oninput="updateLivePreview()">
                                </div>
                                <div class="config-item">
                                    <label>Dislike Text</label>
                                    <input type="color" id="edit-col-dislike-btn" class="color-picker" oninput="updateLivePreview()">
                                </div>
                            </div>
                            <div class="config-item" style="margin-bottom:15px;">
                                <label>Widget Padding</label>
                                <input type="text" id="edit-widget-padding" class="setup-input" oninput="updateLivePreview()">
                            </div>

                            <div class="config-item" style="margin-bottom:15px;">
                                <label>Global Background Image</label>
                                <input type="text" id="edit-bg-image" class="setup-input" oninput="updateLivePreview()">
                            </div>

                            <div class="config-item" style="margin-bottom:15px;">
                                <label>Comments</label>
                                <select id="edit-comments" class="setup-input" onchange="updateLivePreview()">
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>

                            <div class="config-item" style="margin-bottom:15px;">
                                <label>Custom CSS</label>
                                <textarea id="edit-custom-css" class="setup-input" rows="6" oninput="updateLivePreview()"></textarea>
                            </div>

                            <button class="action-btn" onclick="generateConfigFile('edit')">Export New Configuration</button>
                        </div>

                    </div>
                </section>
            </main>
        </div>
    </div>

    <footer>
        <div id="footer-text" style="text-align: center; margin-top: 30px; border-top: 1px dotted var(--border-color); padding: 10px; color: #666;">
            &copy; 2025 LBM | Cloud System
        </div>
    </footer>

    <!-- MODULE: POST DETAIL LIGHTBOX -->
    <div id="leaflet-lightbox" class="lightbox" onclick="if(event.target === this) closeLightbox()">
        <div class="lightbox-content">
            <span class="close-btn" onclick="closeLightbox()">&times;</span>
            <div id="lightbox-body"></div>
        </div>
    </div>

    <!-- MODULE: FULLSCREEN MEDIA OVERLAY -->
    <div id="media-fullscreen-overlay" class="media-overlay" onclick="closeMediaViewer()">
        <span class="close-media-btn" onclick="closeMediaViewer()">&times;</span>
        <div id="media-content-wrapper" onclick="event.stopPropagation()"></div>
    </div>

    <!-- MODULE: SYSTEM LOADER -->
    <script src="system.js" onerror="window.systemMissing=true;"></script>

    <script>
        // --- SECTION: DEFAULTS ---
        let db;
        let postsCache = [];
        let currentConfig = {
            siteName: "LBM // System",
            tagline: "Personal Archive",
            leafletsName: "Leaflets",
            allowComments: true,
            copyright: "2025 LBM | Cloud System",
            bgImage: "",
            bannerImage: "",
            pfpImage: "",
            customCss: "",
            // Reaction Configs
            reactionsEnabled: true,
            reactionIcon: "face", // face, thumb, arrow
            likeLabel: "(Ôºæ‚àáÔºæ)",
            dislikeLabel: "(Ôºõ„Å∏Ôºö)",
            widgetPadding: "10px",
            colors: {
                bg: "#2B2B2B", text: "#F0FFF0", sidebar: "#3B3B3B", accent: "#76c7c0",
                leaflet: "#353535", border: "#555555", navActive: "#FFFFFF",
                like: "#76c7c0", dislike: "#ff7675",
                likeBtn: "#F0FFF0", dislikeBtn: "#F0FFF0"
            }
        };
        let globalFirebaseConfig = null;
        let globalAdminHash = null;
        let isAdminLoggedIn = false; // Track login state for delete button
    
        // --- SECTION: UTILS ---
        // Fix for InvalidCharacterError with emojis/unicode
        function unicodeToBase64(str) {
            return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,
                function toSolidBytes(match, p1) {
                    return String.fromCharCode('0x' + p1);
            }));
        }
    
        function base64ToUnicode(str) {
            return decodeURIComponent(atob(str).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
        }
    
        // --- SECTION: BOOT ---
        window.onload = function() {
            if (window.systemMissing || typeof window.AZUMINT_SYSTEM === 'undefined') {
                console.log("System file missing.");
                showSetup();
            } else {
                try {
                    // Decode system data using the Unicode-safe method
                    const jsonStr = base64ToUnicode(window.AZUMINT_SYSTEM);
                    const data = JSON.parse(jsonStr);
                    
                    globalFirebaseConfig = data.firebaseConfig;
                    globalAdminHash = data.adminHash;
                    // Merge defaults to handle upgrades
                    currentConfig = {
                        ...currentConfig, 
                        ...data.siteConfig, 
                        colors: {...currentConfig.colors, ...(data.siteConfig.colors || {})}
                    };
                    
                    applyVisualConfig();
                    initSystem();
                } catch(e) {
                    console.error("Config Parse Error", e);
                    // Attempt fallback for older files (non-unicode safe)
                    try {
                        const legacyJson = atob(window.AZUMINT_SYSTEM);
                        const data = JSON.parse(legacyJson);
                        globalFirebaseConfig = data.firebaseConfig;
                        globalAdminHash = data.adminHash;
                        currentConfig = {...currentConfig, ...data.siteConfig, colors: {...currentConfig.colors, ...(data.siteConfig.colors || {})}};
                        applyVisualConfig();
                        initSystem();
                    } catch(e2) {
                        alert("Error reading system.js. File might be corrupted.");
                        showSetup();
                    }
                }
            }
        };
    
        function showSetup() {
            document.getElementById('setup-overlay').style.display = 'flex';
            document.title = "System Setup";
            document.getElementById('db-status').innerText = "Pending Setup...";
        }
    
        // --- SECTION: PREVIEW & UPDATE ---
        // Helper to sync inputs for Setup Mode
        function updateSetupPreview() {
            currentConfig.siteName = document.getElementById('setup-site-name').value;
            currentConfig.tagline = document.getElementById('setup-tagline').value;
            currentConfig.leafletsName = document.getElementById('setup-leaflets-name').value;
            currentConfig.copyright = document.getElementById('setup-copyright').value;
            currentConfig.allowComments = document.getElementById('setup-comments').value === 'true';
            currentConfig.bgImage = document.getElementById('setup-bg-image').value;
            currentConfig.pfpImage = document.getElementById('setup-pfp-image').value;
            currentConfig.bannerImage = document.getElementById('setup-banner-image').value;
            currentConfig.customCss = document.getElementById('setup-custom-css').value;
            
            currentConfig.reactionsEnabled = document.getElementById('setup-reactions-enabled').value === 'true';
            currentConfig.reactionIcon = document.getElementById('setup-reaction-icon').value;
            currentConfig.likeLabel = document.getElementById('setup-like-label').value;
            currentConfig.dislikeLabel = document.getElementById('setup-dislike-label').value;
            currentConfig.widgetPadding = document.getElementById('setup-widget-padding').value;
            
            currentConfig.colors.bg = document.getElementById('col-bg').value;
            currentConfig.colors.text = document.getElementById('col-text').value;
            currentConfig.colors.sidebar = document.getElementById('col-sidebar').value;
            currentConfig.colors.accent = document.getElementById('col-accent').value;
            currentConfig.colors.leaflet = document.getElementById('col-leaflet').value;
            currentConfig.colors.border = document.getElementById('col-border').value;
            currentConfig.colors.navActive = document.getElementById('col-nav-active').value;
            
            currentConfig.colors.like = document.getElementById('col-like').value;
            currentConfig.colors.dislike = document.getElementById('col-dislike').value;
            currentConfig.colors.likeBtn = document.getElementById('col-like-btn').value;
            currentConfig.colors.dislikeBtn = document.getElementById('col-dislike-btn').value;
    
            applyVisualConfig();
            // Force redraw of leaflets to show new reaction icons
            renderLeaflets();
        }
    
        // Helper to sync inputs for Edit Mode (Admin Panel)
        function updateLivePreview() {
            currentConfig.siteName = document.getElementById('edit-site-name').value;
            currentConfig.tagline = document.getElementById('edit-tagline').value;
            currentConfig.leafletsName = document.getElementById('edit-leaflets-name').value;
            currentConfig.copyright = document.getElementById('edit-copyright').value;
            currentConfig.allowComments = document.getElementById('edit-comments').value === 'true';
            currentConfig.bgImage = document.getElementById('edit-bg-image').value;
            currentConfig.pfpImage = document.getElementById('edit-pfp-image').value;
            currentConfig.bannerImage = document.getElementById('edit-banner-image').value;
            currentConfig.customCss = document.getElementById('edit-custom-css').value;
            
            currentConfig.reactionsEnabled = document.getElementById('edit-reactions-enabled').value === 'true';
            currentConfig.reactionIcon = document.getElementById('edit-reaction-icon').value;
            currentConfig.likeLabel = document.getElementById('edit-like-label').value;
            currentConfig.dislikeLabel = document.getElementById('edit-dislike-label').value;
            currentConfig.widgetPadding = document.getElementById('edit-widget-padding').value;
            
            currentConfig.colors.bg = document.getElementById('edit-col-bg').value;
            currentConfig.colors.text = document.getElementById('edit-col-text').value;
            currentConfig.colors.sidebar = document.getElementById('edit-col-sidebar').value;
            currentConfig.colors.accent = document.getElementById('edit-col-accent').value;
            currentConfig.colors.leaflet = document.getElementById('edit-col-leaflet').value;
            currentConfig.colors.border = document.getElementById('edit-col-border').value;
            currentConfig.colors.navActive = document.getElementById('edit-col-nav-active').value;
            
            currentConfig.colors.like = document.getElementById('edit-col-like').value;
            currentConfig.colors.dislike = document.getElementById('edit-col-dislike').value;
            currentConfig.colors.likeBtn = document.getElementById('edit-col-like-btn').value;
            currentConfig.colors.dislikeBtn = document.getElementById('edit-col-dislike-btn').value;
    
            applyVisualConfig();
            // Force redraw of leaflets to show new reaction icons
            renderLeaflets();
        }
    
        // Applies the currentConfig state to the DOM
        function applyVisualConfig() {
            document.title = currentConfig.siteName;
            document.getElementById('header-site-name').innerText = currentConfig.siteName;
            document.getElementById('header-tagline').innerText = currentConfig.tagline || "";
            document.getElementById('nav-leaflets-btn').innerText = currentConfig.leafletsName;
            document.getElementById('header-leaflets-title').innerText = "Recent " + currentConfig.leafletsName;
            document.getElementById('footer-text').innerHTML = "&copy; " + currentConfig.copyright;
    
            // Apply Colors
            const r = document.documentElement.style;
            r.setProperty('--background-color', currentConfig.colors.bg);
            r.setProperty('--text-color', currentConfig.colors.text);
            r.setProperty('--sidebar-bg', currentConfig.colors.sidebar);
            r.setProperty('--header-footer-color', currentConfig.colors.sidebar);
            r.setProperty('--accent-color', currentConfig.colors.accent);
            r.setProperty('--leaflet-bg', currentConfig.colors.leaflet);
            r.setProperty('--border-color', currentConfig.colors.border);
            r.setProperty('--nav-active-color', currentConfig.colors.navActive);
            
            r.setProperty('--like-color', currentConfig.colors.like);
            r.setProperty('--dislike-color', currentConfig.colors.dislike);
            r.setProperty('--like-btn-color', currentConfig.colors.likeBtn);
            r.setProperty('--dislike-btn-color', currentConfig.colors.dislikeBtn);
            r.setProperty('--widget-padding', currentConfig.widgetPadding);
            
            // Backgrounds
            if(currentConfig.bgImage && currentConfig.bgImage.length > 5) {
                r.setProperty('--bg-image', `url('${currentConfig.bgImage}')`);
            } else {
                r.setProperty('--bg-image', 'none');
            }
    
            // Header Identity
            const pfpEl = document.getElementById('header-pfp');
            if (currentConfig.pfpImage && currentConfig.pfpImage.length > 5) {
                pfpEl.src = currentConfig.pfpImage;
                pfpEl.style.display = 'block';
            } else {
                pfpEl.style.display = 'none';
            }
    
            const headerEl = document.getElementById('site-header-block');
            if (currentConfig.bannerImage && currentConfig.bannerImage.length > 5) {
                headerEl.style.backgroundImage = `url('${currentConfig.bannerImage}')`;
            } else {
                headerEl.style.backgroundImage = 'none';
            }
    
            // Apply Custom CSS
            const customStyleId = 'custom-css-block';
            let customStyle = document.getElementById(customStyleId);
            if (!customStyle) {
                customStyle = document.createElement('style');
                customStyle.id = customStyleId;
                document.head.appendChild(customStyle);
            }
            customStyle.textContent = currentConfig.customCss || '';
        }
    
        function initSystem() {
            try {
                if(firebase.apps.length === 0) {
                    firebase.initializeApp(globalFirebaseConfig);
                }
                db = firebase.firestore();
                document.getElementById('db-status').innerText = "System Online";
                document.getElementById('db-status').classList.add('online');
                startListener();
            } catch (e) {
                console.error("Firebase Init Error:", e);
                document.getElementById('db-status').innerText = "Database Error";
            }
        }
    
        // --- SECTION: CONFIG GENERATION (SETUP & EDIT) ---
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
        }
    
        async function generateConfigFile(mode) {
            let rawConfig, password, siteData, fbConfigObj;
    
            if (mode === 'setup') {
                rawConfig = document.getElementById('setup-config-text').value;
                password = document.getElementById('setup-password').value;
                if (!rawConfig.includes('apiKey') || !password) return alert("Missing Firebase Config or Password.");
                
                let cleanConfig = rawConfig.trim();
                if(cleanConfig.startsWith('const')) cleanConfig = cleanConfig.replace(/const\s+firebaseConfig\s*=\s*/, '');
                if(cleanConfig.endsWith(';')) cleanConfig = cleanConfig.slice(0, -1);
                
                try {
                    fbConfigObj = new Function("return " + cleanConfig)();
                } catch(e) {
                    return alert("Invalid Firebase Config format.");
                }
    
                siteData = {
                    siteName: document.getElementById('setup-site-name').value,
                    tagline: document.getElementById('setup-tagline').value,
                    leafletsName: document.getElementById('setup-leaflets-name').value,
                    copyright: document.getElementById('setup-copyright').value,
                    allowComments: document.getElementById('setup-comments').value === 'true',
                    bgImage: document.getElementById('setup-bg-image').value,
                    pfpImage: document.getElementById('setup-pfp-image').value,
                    bannerImage: document.getElementById('setup-banner-image').value,
                    customCss: document.getElementById('setup-custom-css').value,
                    
                    reactionsEnabled: document.getElementById('setup-reactions-enabled').value === 'true',
                    reactionIcon: document.getElementById('setup-reaction-icon').value,
                    likeLabel: document.getElementById('setup-like-label').value,
                    dislikeLabel: document.getElementById('setup-dislike-label').value,
                    widgetPadding: document.getElementById('setup-widget-padding').value,
                    
                    colors: {
                        bg: document.getElementById('col-bg').value,
                        text: document.getElementById('col-text').value,
                        sidebar: document.getElementById('col-sidebar').value,
                        accent: document.getElementById('col-accent').value,
                        leaflet: document.getElementById('col-leaflet').value,
                        border: document.getElementById('col-border').value,
                        navActive: document.getElementById('col-nav-active').value,
                        like: document.getElementById('col-like').value,
                        dislike: document.getElementById('col-dislike').value,
                        likeBtn: document.getElementById('col-like-btn').value,
                        dislikeBtn: document.getElementById('col-dislike-btn').value
                    }
                };
            } else {
                fbConfigObj = globalFirebaseConfig;
                password = null;
    
                siteData = {
                    siteName: document.getElementById('edit-site-name').value,
                    tagline: document.getElementById('edit-tagline').value,
                    leafletsName: document.getElementById('edit-leaflets-name').value,
                    copyright: document.getElementById('edit-copyright').value,
                    allowComments: document.getElementById('edit-comments').value === 'true',
                    bgImage: document.getElementById('edit-bg-image').value,
                    pfpImage: document.getElementById('edit-pfp-image').value,
                    bannerImage: document.getElementById('edit-banner-image').value,
                    customCss: document.getElementById('edit-custom-css').value,
                    
                    reactionsEnabled: document.getElementById('edit-reactions-enabled').value === 'true',
                    reactionIcon: document.getElementById('edit-reaction-icon').value,
                    likeLabel: document.getElementById('edit-like-label').value,
                    dislikeLabel: document.getElementById('edit-dislike-label').value,
                    widgetPadding: document.getElementById('edit-widget-padding').value,
                    
                    colors: {
                        bg: document.getElementById('edit-col-bg').value,
                        text: document.getElementById('edit-col-text').value,
                        sidebar: document.getElementById('edit-col-sidebar').value,
                        accent: document.getElementById('edit-col-accent').value,
                        leaflet: document.getElementById('edit-col-leaflet').value,
                        border: document.getElementById('edit-col-border').value,
                        navActive: document.getElementById('edit-col-nav-active').value,
                        like: document.getElementById('edit-col-like').value,
                        dislike: document.getElementById('edit-col-dislike').value,
                        likeBtn: document.getElementById('edit-col-like-btn').value,
                        dislikeBtn: document.getElementById('edit-col-dislike-btn').value
                    }
                };
            }
    
            let hashVar = (mode === 'setup') ? await sha256(password) : globalAdminHash;
    
            const fullConfig = {
                firebaseConfig: fbConfigObj,
                adminHash: hashVar,
                siteConfig: siteData
            };
    
            const jsonStr = JSON.stringify(fullConfig);
            // USE NEW ENCODING METHOD
            const encodedStr = unicodeToBase64(jsonStr);
            
            const fileContent = `window.AZUMINT_SYSTEM = "${encodedStr}";`;
            
            const blob = new Blob([fileContent], { type: "text/javascript" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "system.js";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert("Config generated! Upload 'system.js' to your site folder.");
        }
    
        // --- SECTION: ADMIN AUTH ---
        async function adminLogin() {
            const inputPass = document.getElementById('login-pass').value;
            if(!globalAdminHash) return alert("Config missing.");
            
            const inputHash = await sha256(inputPass);
            if(inputHash === globalAdminHash) {
                isAdminLoggedIn = true; // Flag for UI elements
                document.getElementById('admin-login-form').style.display = 'none';
                document.getElementById('admin-dashboard').style.display = 'block';
                document.getElementById('login-pass').value = '';
                
                // Re-render posts to show delete buttons
                renderLeaflets();
                renderGallery();
                
                document.getElementById('edit-site-name').value = currentConfig.siteName;
                document.getElementById('edit-tagline').value = currentConfig.tagline;
                document.getElementById('edit-leaflets-name').value = currentConfig.leafletsName;
                document.getElementById('edit-copyright').value = currentConfig.copyright;
                document.getElementById('edit-comments').value = currentConfig.allowComments;
                document.getElementById('edit-bg-image').value = currentConfig.bgImage;
                document.getElementById('edit-pfp-image').value = currentConfig.pfpImage;
                document.getElementById('edit-banner-image').value = currentConfig.bannerImage;
                document.getElementById('edit-custom-css').value = currentConfig.customCss;
                
                document.getElementById('edit-reactions-enabled').value = currentConfig.reactionsEnabled;
                document.getElementById('edit-reaction-icon').value = currentConfig.reactionIcon;
                document.getElementById('edit-like-label').value = currentConfig.likeLabel;
                document.getElementById('edit-dislike-label').value = currentConfig.dislikeLabel;
                document.getElementById('edit-widget-padding').value = currentConfig.widgetPadding;
                
                document.getElementById('edit-col-bg').value = currentConfig.colors.bg;
                document.getElementById('edit-col-text').value = currentConfig.colors.text;
                document.getElementById('edit-col-sidebar').value = currentConfig.colors.sidebar;
                document.getElementById('edit-col-accent').value = currentConfig.colors.accent;
                document.getElementById('edit-col-leaflet').value = currentConfig.colors.leaflet;
                document.getElementById('edit-col-border').value = currentConfig.colors.border;
                document.getElementById('edit-col-nav-active').value = currentConfig.colors.navActive;
                
                document.getElementById('edit-col-like').value = currentConfig.colors.like;
                document.getElementById('edit-col-dislike').value = currentConfig.colors.dislike;
                document.getElementById('edit-col-like-btn').value = currentConfig.colors.likeBtn;
                document.getElementById('edit-col-dislike-btn').value = currentConfig.colors.dislikeBtn;
            } else {
                alert("Incorrect Password");
            }
        }
    
        function switchAdminSubTab(tab) {
            document.getElementById('admin-sub-post').style.display = 'none';
            document.getElementById('admin-sub-settings').style.display = 'none';
            document.getElementById('admin-sub-'+tab).style.display = 'block';
        }
    
        // --- SECTION: DATABASE LOGIC ---
        function startListener() {
            if (!db) return;
            db.collection("posts").orderBy("id", "desc").onSnapshot((snapshot) => {
                postsCache = [];
                snapshot.forEach((doc) => {
                    postsCache.push({ uid: doc.id, ...doc.data() });
                });
                renderLeaflets();
                renderGallery();
                if(currentLightboxPostId) {
                    const updatedPost = postsCache.find(p => p.id === currentLightboxPostId);
                    // If post deleted while open, close lightbox
                    if(!updatedPost) {
                        closeLightbox();
                    } else {
                        renderLightboxContent(updatedPost);
                    }
                }
            });
        }
    
        function renderLeaflets() {
            const container = document.getElementById('leaflets-container');
            if(postsCache.length === 0) { container.innerHTML = `<p>No ${currentConfig.leafletsName} yet.</p>`; return; }
            container.innerHTML = '';
            
            postsCache.forEach(post => {
                const total = (post.likes || 0) + (post.dislikes || 0);
                const ratio = total === 0 ? 50 : (post.likes / total) * 100;
                const type = getMediaType(post.media);
                let mediaHtml = '';
                if (post.media) {
                    if (type === 'video') mediaHtml = `<div class="leaflet-media-container"><video controls loop muted playsinline onclick="event.stopPropagation(); openMediaViewer('${post.media}', 'video')"><source src="${post.media}" type="video/mp4"></video></div>`;
                    else mediaHtml = `<div class="leaflet-media-container"><img src="${post.media}" alt="Attached Media" onclick="event.stopPropagation(); openMediaViewer('${post.media}', 'image')"></div>`;
                }
                const postContentHtml = typeof marked !== 'undefined' ? marked.parse(post.content) : post.content;
                
                // AVATAR
                let avatarContent = 'üåø';
                if(currentConfig.pfpImage && currentConfig.pfpImage.length > 5) {
                    avatarContent = `<img src="${currentConfig.pfpImage}" style="width:100%; height:100%; object-fit:cover;">`;
                }
                
                // REACTION LOGIC
                let reactionHtml = '';
                if (currentConfig.reactionsEnabled) {
                    let likeTxt = currentConfig.likeLabel;
                    let dislikeTxt = currentConfig.dislikeLabel;
                    if(currentConfig.reactionIcon === 'thumb') { likeTxt = 'üëç'; dislikeTxt = 'üëé'; }
                    if(currentConfig.reactionIcon === 'arrow') { likeTxt = '‚ñ≤'; dislikeTxt = '‚ñº'; }
                    
                    reactionHtml = `
                    <div class="reaction-widget" onclick="event.stopPropagation()">
                        <button class="reaction-btn like-btn" onclick="handleReaction('${post.uid}', 'like', ${post.likes || 0})">${post.likes || 0} ${likeTxt}</button>
                        <div class="reaction-bar"><div class="reaction-fill" style="width: ${ratio}%"></div></div>
                        <button class="reaction-btn dislike-btn" onclick="handleReaction('${post.uid}', 'dislike', ${post.dislikes || 0})">${dislikeTxt} ${post.dislikes || 0}</button>
                    </div>`;
                }
    
                // ADMIN DELETE BUTTON
                let deleteBtn = '';
                if (isAdminLoggedIn) {
                    deleteBtn = `<button class="delete-btn" onclick="deletePost('${post.uid}', event)">[x] Delete</button>`;
                }
    
                const html = `
                <article class="leaflet-item" onclick="openLightbox(${post.id})">
                    <div class="leaflet-avatar">${avatarContent}</div>
                    <div class="leaflet-body">
                        <div class="leaflet-header">
                            <span class="leaflet-author">Admin</span><span>${post.date}</span>
                            ${deleteBtn}
                        </div>
                        <div class="leaflet-content"><div>${postContentHtml}</div>${mediaHtml}</div>
                        ${reactionHtml}
                    </div>
                </article>`;
                container.innerHTML += html;
            });
        }
    
        function renderGallery() {
            const container = document.getElementById('gallery-container');
            const galleryItems = postsCache.filter(p => p.media);
            if(galleryItems.length === 0) { container.innerHTML = "<p>No images.</p>"; return; }
            container.innerHTML = '';
            galleryItems.forEach(item => {
                const type = getMediaType(item.media);
                // Hover effects for video in gallery
                let mediaElement = type === 'video' 
                    ? `<video src="${item.media}" muted loop onmouseover="this.play()" onmouseout="this.pause()"></video><div class="video-indicator">VIDEO</div>` 
                    : `<img src="${item.media}" loading="lazy">`;
                // Click now opens Media Viewer directly instead of Post Details
                container.innerHTML += `<div class="gallery-item" onclick="openMediaViewer('${item.media}', '${type}')">${mediaElement}</div>`;
            });
        }
    
        function handleReaction(docUid, type, currentCount) {
            if (!db) return;
            const update = {};
            update[type === 'like' ? 'likes' : 'dislikes'] = currentCount + 1;
            db.collection("posts").doc(docUid).update(update);
        }
    
        function addPost() {
            const content = document.getElementById('admin-content').value;
            const media = document.getElementById('admin-media').value;
            if (!content) return alert("Content required");
            const newPost = {
                id: Date.now(),
                date: new Date().toISOString().slice(0, 16).replace('T', ' '),
                content: content,
                media: media,
                likes: 0, dislikes: 0, comments: []
            };
            db.collection("posts").add(newPost).then(() => {
                alert("Posted!");
                document.getElementById('admin-content').value = '';
                document.getElementById('admin-media').value = '';
                document.getElementById('file-selector').value = '';
                document.getElementById('upload-preview').style.display = 'none';
            });
        }
    
        // Delete Post
        function deletePost(docUid, event) {
            event.stopPropagation(); // Prevent lightbox opening
            if (!confirm("Are you sure you want to delete this post? This cannot be undone.")) return;
            
            db.collection("posts").doc(docUid).delete().then(() => {
                console.log("Post successfully deleted!");
                // UI updates automatically via snapshot listener
            }).catch((error) => {
                console.error("Error removing post: ", error);
                alert("Error deleting post: " + error.message);
            });
        }
    
        // --- SECTION: LIGHTBOX ---
        let currentLightboxPostId = null;
        function openLightbox(postId) {
            currentLightboxPostId = postId;
            const post = postsCache.find(p => p.id === postId);
            if(!post) return;
            renderLightboxContent(post);
            document.getElementById('leaflet-lightbox').classList.add('open');
            document.body.classList.add('modal-open');
        }
    
        function renderLightboxContent(post) {
            const body = document.getElementById('lightbox-body');
            const comments = post.comments || [];
            
            let commentsHtml = '';
            if (currentConfig.allowComments) {
                const renderTree = (parentId, depth) => {
                    const children = comments.filter(c => c.parentId === parentId);
                    if(!children.length) return '';
                    let h = `<ul class="${depth>0?'reply-list':'comments-list'}">`;
                    children.forEach(c => {
                        let deleteBtn = '';
                        if(isAdminLoggedIn) {
                            deleteBtn = `<button class="delete-btn" style="float:right; font-size:10px;" onclick="deleteComment('${post.uid}', ${c.id})">[x]</button>`;
                        }
                        
                        h += `<li class="comment-item">
                                <div class="comment-header">
                                    <span class="comment-author">${c.author}</span>
                                    <span>${c.date}</span>
                                    ${deleteBtn}
                                </div>
                                <div class="comment-text">${c.text}</div>
                                <button class="reply-btn" onclick="setReplyTarget(${c.id}, '${c.author}')">Reply</button>
                                ${renderTree(c.id, depth+1)}
                              </li>`;
                    });
                    return h + '</ul>';
                };
    
                commentsHtml = `<div class="comments-section">
                    <h3>Comments</h3>
                    <div id="comments-container">${comments.length ? renderTree(null, 0) : '<p>No comments.</p>'}</div>
                    <div class="comment-form">
                        <h4>Add Comment</h4>
                        <input type="text" id="comment-author" placeholder="Name">
                        <input type="hidden" id="comment-parent-id" value="">
                        <div id="reply-display" style="display:none;font-size:11px;color:var(--accent-color);">Replying to <span id="reply-name"></span> <button onclick="cancelReply()">(x)</button></div>
                        <textarea id="comment-text" rows="2" placeholder="Write a comment..."></textarea>
                        <button class="action-btn" onclick="submitComment('${post.uid}')">Post</button>
                    </div>
                </div>`;
            } else {
                commentsHtml = `<div class="comments-section"><p style="color:#888; text-align:center;">Comments are disabled.</p></div>`;
            }
    
            let mediaHtml = '';
            if (post.media) {
                 const type = getMediaType(post.media);
                 if (type === 'video') mediaHtml = `<div class="leaflet-media-container"><video controls autoplay loop muted playsinline style="width:100%" onclick="openMediaViewer('${post.media}', 'video')"><source src="${post.media}" type="video/mp4"></video></div>`;
                 else mediaHtml = `<div class="leaflet-media-container"><img src="${post.media}" style="width:100%" onclick="openMediaViewer('${post.media}', 'image')"></div>`;
            }
    
            const postContentHtml = typeof marked !== 'undefined' ? marked.parse(post.content) : post.content;
    
            // AVATAR LOGIC
            let avatarContent = 'üåø';
            if(currentConfig.pfpImage && currentConfig.pfpImage.length > 5) {
                avatarContent = `<img src="${currentConfig.pfpImage}" style="width:100%; height:100%; object-fit:cover;">`;
            }
    
            body.innerHTML = `
                <div class="leaflet-item" style="cursor:default;">
                    <div class="leaflet-avatar">${avatarContent}</div>
                    <div class="leaflet-body">
                        <div class="leaflet-header"><span class="leaflet-author">Admin</span><span>${post.date}</span></div>
                        <div class="leaflet-content"><div>${postContentHtml}</div>${mediaHtml}</div>
                    </div>
                </div>
                ${commentsHtml}`;
        }
    
        function submitComment(docUid) {
            const author = document.getElementById('comment-author').value || "Guest";
            let text = document.getElementById('comment-text').value;
            const parentId = document.getElementById('comment-parent-id').value ? parseInt(document.getElementById('comment-parent-id').value) : null;
            if (!text) return alert("Write something!");

            const newComment = { id: Date.now(), author: author, text: text, date: new Date().toISOString().slice(0, 16).replace('T', ' '), parentId: parentId };
            db.collection("posts").doc(docUid).update({ comments: firebase.firestore.FieldValue.arrayUnion(newComment) });
        }
        
        function deleteComment(postUid, commentId) {
            if(!confirm("Delete this comment?")) return;
            const post = postsCache.find(p => p.uid === postUid);
            if(!post) return;
            const commentObj = post.comments.find(c => c.id === commentId);
            if(!commentObj) return;
            
            db.collection("posts").doc(postUid).update({
                comments: firebase.firestore.FieldValue.arrayRemove(commentObj)
            }).catch(err => alert(err.message));
        }
    
        function setReplyTarget(id, name) { document.getElementById('comment-parent-id').value = id; document.getElementById('reply-name').innerText = name; document.getElementById('reply-display').style.display = 'block'; }
        function cancelReply() { document.getElementById('comment-parent-id').value = ''; document.getElementById('reply-display').style.display = 'none'; }
        function closeLightbox() { document.getElementById('leaflet-lightbox').classList.remove('open'); document.body.classList.remove('modal-open'); currentLightboxPostId = null; }
        function getMediaType(url) { if (!url) return null; const ext = url.split('.').pop().toLowerCase(); if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) return 'image'; if (['mp4', 'webm', 'ogg'].includes(ext)) return 'video'; return 'image'; }
        function handleFileSelect() { const file = document.getElementById('file-selector').files[0]; if (file) { document.getElementById('admin-media').value = `img/${file.name}`; document.getElementById('upload-preview').src = URL.createObjectURL(file); document.getElementById('upload-preview').style.display = 'block'; } }
        function switchTab(tabName) { document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active')); document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active')); document.getElementById(`tab-${tabName}`).classList.add('active'); if(tabName === 'admin') document.getElementById('admin-tab-btn').classList.add('active'); else if(tabName === 'leaflets') document.getElementById('nav-leaflets-btn').classList.add('active'); }

        // --- SECTION: FULLSCREEN MEDIA VIEWER ---
        function openMediaViewer(url, type) {
            const overlay = document.getElementById('media-fullscreen-overlay');
            const wrapper = document.getElementById('media-content-wrapper');
            wrapper.innerHTML = '';
            
            if (type === 'video') {
                wrapper.innerHTML = `<video controls autoplay loop style="width:auto; height:auto; max-width:95vw; max-height:95vh;"><source src="${url}" type="video/mp4"></video>`;
            } else {
                wrapper.innerHTML = `<img src="${url}" style="width:auto; height:auto; max-width:95vw; max-height:95vh;">`;
            }
            
            overlay.classList.add('active');
            document.body.classList.add('modal-open');
        }

        function closeMediaViewer() {
            const overlay = document.getElementById('media-fullscreen-overlay');
            overlay.classList.remove('active');
            // Only remove body modal-open if the detail lightbox isn't also open
            if(!currentLightboxPostId) {
                document.body.classList.remove('modal-open');
            }
            // Pause video on close
            const video = overlay.querySelector('video');
            if(video) video.pause();
        }
    </script>

</body>

</html>