<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEERG // Art Blog â€” V4.0</title>
    <meta name="description" content="Digital art archive by NEERG â€” V4.0">
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:; img-src * data: blob:; media-src * data: blob:; connect-src * 'unsafe-inline';">

    <!--
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘  Built on LBM (Leaflet Blog Manager)                         â•‘
    â•‘  Original engine by: https://lbm-test.neocities.org          â•‘
    â•‘  V4.0 â€” Pill Nav Â· Scroll Velocity Â· Staggered Menu          â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    -->

    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <link rel="stylesheet" href="style.css">
</head>
<body>

    <!-- Toast Container -->
    <div id="toast-container" style="position:fixed;bottom:1.5rem;left:50%;transform:translateX(-50%);z-index:9999;display:flex;flex-direction:column;gap:0.5rem;align-items:center;"></div>

    <!-- Bridge Frame (handles Neocities API uploads) -->
    <iframe id="bridge-frame" style="width:1px;height:1px;opacity:0;position:absolute;pointer-events:none;"></iframe>

    <!-- Token Repair Modal -->
    <div id="repair-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.9);z-index:10001;align-items:center;justify-content:center;backdrop-filter:blur(5px);">
        <div style="background:var(--bg-card);border:1px solid var(--pink);padding:30px;width:320px;text-align:center;border-radius:12px;">
            <h3 style="color:var(--pink);margin-bottom:10px;font-family:var(--font-display);">CONNECTION REPAIR</h3>
            <p style="color:#aaa;font-size:12px;margin-bottom:15px;font-family:var(--font-mono);">Your Secure Token was rejected. Please re-authenticate.</p>
            <input type="password" id="repair-api-key" class="setup-input" placeholder="Neocities API Key" style="margin-bottom:15px;" autocomplete="off">
            <button class="action-btn" onclick="runRepair()">Generate New Token & Sync</button>
            <button onclick="document.getElementById('repair-modal').style.display='none'" style="background:transparent;border:none;margin-top:10px;color:#888;cursor:pointer;font-family:var(--font-mono);">Cancel</button>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• SYNC OVERLAY â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="sync-overlay" style="display:none;">
        <h3>SYSTEM SYNC</h3>
        <div class="sync-bar"></div>
        <p style="font-family:var(--font-mono);font-size:0.65rem;color:var(--gray);">Initiating upload sequence...</p>
        <button onclick="document.getElementById('sync-overlay').style.display='none';document.getElementById('sync-overlay').classList.remove('active')" 
                style="margin-top:0.5rem;padding:0.4rem 1rem;background:var(--border);border:none;color:var(--white);border-radius:var(--radius-pill);cursor:pointer;font-family:var(--font-mono);font-size:0.65rem;">Close</button>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• SETUP WIZARD â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="setup-wizard">
        <h1>SYSTEM BOOT // INITIAL SETUP</h1>

        <h3>1. System Configuration</h3>
        <p style="font-family:var(--font-mono);font-size:0.7rem;color:var(--gray);margin-bottom:1rem;">Configure admin credentials and API connectivity.</p>
        <p style="font-family:var(--font-mono);font-size:0.6rem;color:var(--lime);margin-bottom:1rem;padding:0.75rem;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-sm);">
            ðŸ”’ <strong>SECURITY TIPS:</strong><br>
            â€¢ Use a strong, unique password (8+ characters)<br>
            â€¢ Your API key is stored ONLY on this device<br>
            â€¢ Never share your API key with anyone<br>
            â€¢ Regenerate your Neocities API key if compromised
        </p>
        <label>Create Admin Password (min 8 characters):</label>
        <input type="password" id="setup-password" class="setup-input" placeholder="Minimum 8 characters">
        <label>Neocities API Key:</label>
        <input type="password" id="setup-neocities-key" class="setup-input" placeholder="API Key (will be encrypted into a Secure Token)" autocomplete="off">
        <p style="font-family:var(--font-mono);font-size:0.55rem;color:var(--lime);margin-top:0.25rem;">âœ“ Key is encrypted â€” never stored as plain text</p>

        <h3>2. Branding</h3>
        <label>Site Name</label><input type="text" id="setup-sitename" class="setup-input" value="MY ART BLOG">
        <label>Tagline</label><input type="text" id="setup-tagline" class="setup-input" value="Digital Art Archive">
        <label>Posts Tab</label><input type="text" id="setup-posts-tab" class="setup-input" value="Works">
        <label>Copyright</label><input type="text" id="setup-copyright" class="setup-input" value="2026 Artist Blog">
        <label>Profile Picture URL</label><input type="text" id="setup-pfp" class="setup-input" placeholder="https://...">
        <label>Header Banner URL</label><input type="text" id="setup-banner" class="setup-input" placeholder="https://...">

        <h3>3. Theme</h3>
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:0.75rem;">
            <div><label>Background</label><input type="color" id="setup-bg" value="#0d0d0d"></div>
            <div><label>Text</label><input type="color" id="setup-text" value="#f0f0f0"></div>
            <div><label>Sidebar/Footer</label><input type="color" id="setup-sidebar" value="#1a1a1a"></div>
            <div><label>Accent</label><input type="color" id="setup-accent" value="#ff6b35"></div>
            <div><label>Post Bg</label><input type="color" id="setup-post-bg" value="#1a1a1a"></div>
            <div><label>Borders</label><input type="color" id="setup-borders" value="#333333"></div>
            <div><label>Active Nav</label><input type="color" id="setup-nav-active" value="#c8ff00"></div>
        </div>

        <h3>4. Interactions</h3>
        <label>Enable Reactions?</label>
        <select id="setup-reactions" class="setup-input" style="max-width:200px;">
            <option value="true">Yes</option>
            <option value="false">No</option>
        </select>
        <label>Icon Style</label>
        <select id="setup-icon-style" class="setup-input" style="max-width:200px;">
            <option value="faces">Faces (^_^)</option>
            <option value="thumbs">Thumbs ðŸ‘</option>
            <option value="arrows">Arrows â¬†</option>
        </select>
        <label>Like Label</label><input type="text" id="setup-like-label" class="setup-input" value="Like">
        <label>Dislike Label</label><input type="text" id="setup-dislike-label" class="setup-input" value="Dislike">
        <label>Like Color</label><input type="color" id="setup-like-color" value="#c8ff00">
        <label>Dislike Color</label><input type="color" id="setup-dislike-color" value="#ff3c8e">
        <label>Like Button Text</label><input type="color" id="setup-like-btn" value="#0d0d0d">
        <label>Dislike Button Text</label><input type="color" id="setup-dislike-btn" value="#0d0d0d">
        <label>Widget Padding</label><input type="text" id="setup-widget-padding" class="setup-input" value="1.5rem">
        <label>Global Background Image (Optional)</label><input type="text" id="setup-bg-image" class="setup-input" placeholder="URL or leave empty">
        <label>Allow Comments?</label>
        <select id="setup-comments" class="setup-input" style="max-width:200px;">
            <option value="true">Yes</option>
            <option value="false">No</option>
        </select>
        <label>Custom CSS (Advanced)</label>
        <textarea id="setup-custom-css" class="setup-input" rows="3" style="max-width:100%;"></textarea>

        <br><br>
        <button class="action-btn" onclick="generateSystem()" style="width:100%;max-width:400px;padding:0.8rem;">GENERATE system.js</button>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• TOP NAVIGATION BAR â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <nav class="top-nav">
        <div class="nav-left">
            <a class="nav-logo" onclick="switchTab('posts', this)" style="cursor:pointer;">
                <img class="pfp" id="nav-pfp" src="" alt="PFP" onerror="this.style.display='none'">
                <span class="site-name" id="nav-sitename">Artist Blog</span>
            </a>
        </div>

        <div class="nav-center" id="nav-center">
            <div class="pill-indicator" id="pill-indicator"></div>
            <button class="nav-link active" onclick="switchTab('posts', this)">Home</button>
            <button class="nav-link" onclick="switchTab('about', this)">About</button>
            <button class="nav-link" onclick="switchTab('gallery', this)">Gallery</button>
            <button class="nav-link" onclick="switchTab('commissions', this)">Commissions</button>
        </div>

        <div class="nav-right">
            <button class="nav-icon-btn" onclick="toggleDarkLight()" title="Toggle theme">â—‘</button>
            <button class="nav-link" onclick="switchTab('admin', this)">Admin Login</button>
            <button class="hamburger-btn" onclick="toggleMobileMenu()" aria-label="Menu">â˜°</button>
        </div>
    </nav>

    <!-- Mobile menu dropdown (only visible on mobile when hamburger is tapped) -->
    <div class="mobile-menu" id="mobile-menu" style="display:none;">
        <button class="nav-link" onclick="switchTab('posts', this); closeMobileMenu();">Home</button>
        <button class="nav-link" onclick="switchTab('about', this); closeMobileMenu();">About</button>
        <button class="nav-link" onclick="switchTab('gallery', this); closeMobileMenu();">Gallery</button>
        <button class="nav-link" onclick="switchTab('commissions', this); closeMobileMenu();">Commissions</button>
        <button class="nav-link" onclick="switchTab('admin', this); closeMobileMenu();">Admin Login</button>
        <button class="nav-link" onclick="toggleDarkLight(); closeMobileMenu();">Toggle Theme</button>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• ANIMATED MARQUEE BANNER â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="marquee-container" id="marquee-container">
        <div class="marquee" id="marquee-track">
            <span>ART WEEKLY</span><span>SFW ART</span><span>NSFW ART</span>
            <span>ART WEEKLY</span><span>SFW ART</span><span>NSFW ART</span>
            <span>ART WEEKLY</span><span>SFW ART</span><span>NSFW ART</span>
            <span>ART WEEKLY</span><span>SFW ART</span><span>NSFW ART</span>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• FEATURED CARDS CAROUSEL â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="featured-cards-section" id="featured-cards-section" style="display:none;">
        <div class="featured-cards-viewport">
            <div class="featured-cards-track" id="featured-cards-track">
                <!-- Populated dynamically: up to 5 newest image posts -->
            </div>
        </div>
        <div class="featured-cards-dots" id="featured-cards-dots"></div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAIN CONTENT â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <main class="main-content">

        <!-- â•â•â•â•â•â•â•â• POSTS SECTION (Home) â•â•â•â•â•â•â•â• -->
        <section id="section-posts" class="content-section active">

            <div class="search-bar">
                <input type="text" id="search-input" placeholder="Search posts..." oninput="filterPosts()">
                <button class="search-btn" onclick="filterPosts()">Search</button>
            </div>

            <div class="filter-bar">
                <label>Sort by</label>
                <select class="sort-select" id="sort-select" onchange="sortPosts()">
                    <option value="newest">Newest</option>
                    <option value="oldest">Oldest</option>
                    <option value="popular">Most Popular</option>
                    <option value="unpopular">Less Popular</option>
                </select>
            </div>

            <div class="tags-bar" id="tags-bar">
                <button class="tag-pill active" data-tag="all" onclick="filterByTag('all', this)">All</button>
                <button class="tag-pill" data-tag="sfw" onclick="filterByTag('sfw', this)">SFW</button>
                <button class="tag-pill" data-tag="nsfw" onclick="filterByTag('nsfw', this)">NSFW</button>
                <button class="tag-pill" data-tag="sketch" onclick="filterByTag('sketch', this)">Sketch</button>
                <button class="tag-pill" data-tag="commissions" onclick="filterByTag('commissions', this)">Commissions</button>
                <button class="tag-pill" data-tag="animation" onclick="filterByTag('animation', this)">Animation</button>
            </div>

            <h2 style="font-family:var(--font-heading);font-weight:700;font-size:1.3rem;margin-bottom:1rem;" id="posts-title">Recent Works</h2>

            <div id="leaflets-container">
                <p style="font-family:var(--font-mono);font-size:0.75rem;color:var(--gray);">Loading content...</p>
            </div>

            <div class="pagination" id="pagination"></div>
        </section>

        <!-- â•â•â•â•â•â•â•â• GALLERY SECTION â•â•â•â•â•â•â•â• -->
        <section id="section-gallery" class="content-section">
            <h2 style="font-family:var(--font-heading);font-weight:700;font-size:1.3rem;margin-bottom:1rem;">Image Gallery</h2>
            <div id="gallery-container" class="gallery-grid">Loading...</div>
        </section>

        <!-- â•â•â•â•â•â•â•â• ABOUT SECTION â•â•â•â•â•â•â•â• -->
        <section id="section-about" class="content-section">
            <div class="about-hero">
                <img class="about-pfp" id="about-pfp" src="" alt="Profile" onerror="this.style.display='none'">
                <div class="about-name" id="about-name">NEERG</div>
                <div class="about-tagline" id="about-tagline">Digital Art Archive</div>
                <div class="about-bio" id="about-bio">Welcome to my art blog! This is where I share my digital artwork, original characters, and fanart. Feel free to explore and leave comments on anything you like.</div>
                <div class="social-links" id="social-links-display"></div>
            </div>
        </section>

        <!-- â•â•â•â•â•â•â•â• COMMISSIONS SECTION â•â•â•â•â•â•â•â• -->
        <section id="section-commissions" class="content-section">
            <div class="about-hero">
                <h2 style="font-family:var(--font-heading);font-weight:700;font-size:1.5rem;margin-bottom:1rem;">Commissions</h2>
                <p id="commissions-text" style="max-width:600px;margin:0 auto;line-height:1.8;color:var(--gray-light);">Commission info coming soon! Check back later for pricing and availability.</p>
            </div>
        </section>

        <!-- â•â•â•â•â•â•â•â• ADMIN SECTION â•â•â•â•â•â•â•â• -->
        <section id="section-admin" class="content-section">
            <div id="admin-login">
                <h2>Admin // Access</h2>
                <p>Enter your admin password to access the dashboard.</p>
                <input type="password" id="admin-pass" placeholder="Password" onkeydown="if(event.key==='Enter')loginAdmin()">
                <br><button class="action-btn" onclick="loginAdmin()" style="margin-top:0.75rem;">Access System</button>
            </div>

            <div id="admin-panel" style="display:none;">

                <div class="admin-toolbar">
                    <button class="action-btn" onclick="forceSyncAll()" style="font-size:0.75rem;">ðŸ”„ FORCE SYNC</button>
                    <button class="btn-secondary" onclick="downloadSystemJS()">â¬‡ JS</button>
                    <button class="btn-secondary" onclick="downloadHTML()">â¬‡ HTML</button>
                </div>

                <div style="display:flex;gap:0.4rem;margin-bottom:1.5rem;flex-wrap:wrap;">
                    <button class="nav-link active" onclick="showAdminTab('create', this)">New Post</button>
                    <button class="nav-link" onclick="showAdminTab('manage', this)">Manage Posts</button>
                    <button class="nav-link" onclick="showAdminTab('settings', this)">Site Settings</button>
                    <button class="nav-link" onclick="showAdminTab('banner-settings', this)">Banner</button>
                    <button class="nav-link" onclick="showAdminTab('social', this)">Social Links</button>
                    <button class="btn-danger" onclick="logoutAdmin()" style="margin-left:auto;">Logout</button>
                </div>

                <!-- â”€â”€ CREATE POST TAB â”€â”€ -->
                <div id="admin-tab-create" class="admin-tab active" style="display:block;">
                    <h3>Create New Content</h3>
                    <textarea id="new-post-content" style="width:100%;min-height:120px;margin-bottom:0.5rem;" placeholder="Write your post... (supports **bold**, *italic*, [links](url))"></textarea>
                    <label>Media â€” Upload Image</label>
                    <input type="file" id="new-post-media-file" accept="image/*,video/mp4,video/webm" 
                           style="width:100%;max-width:500px;margin-bottom:0.5rem;font-family:var(--font-mono);font-size:0.75rem;color:var(--gray-light);"
                           onchange="handleFileUpload(this)">
                    <div id="upload-preview" style="display:none;margin-bottom:0.5rem;">
                        <img id="upload-preview-img" style="max-width:200px;max-height:150px;border-radius:8px;border:1px solid var(--border);">
                        <button type="button" onclick="clearUpload()" style="display:block;margin-top:0.3rem;font-family:var(--font-mono);font-size:0.65rem;color:var(--pink);background:none;border:none;cursor:pointer;">âœ• Remove</button>
                    </div>
                    <label>â€” OR paste a Media URL</label>
                    <input type="text" id="new-post-media-url" style="width:100%;max-width:500px;margin-bottom:0.5rem;" placeholder="https://... (paste image/video URL)">
                    <label>Tags (click to select)</label>
                    <div id="new-post-tags-bar" style="display:flex;flex-wrap:wrap;gap:0.4rem;margin-bottom:0.75rem;">
                        <button type="button" class="tag-toggle" data-tag="SFW" onclick="this.classList.toggle('selected')" style="font-family:var(--font-body);font-size:0.8rem;padding:0.4rem 0.9rem;border-radius:20px;border:1px solid var(--border-light);background:transparent;color:var(--gray-light);cursor:pointer;transition:all 0.2s;">SFW</button>
                        <button type="button" class="tag-toggle" data-tag="NSFW" onclick="this.classList.toggle('selected')" style="font-family:var(--font-body);font-size:0.8rem;padding:0.4rem 0.9rem;border-radius:20px;border:1px solid var(--border-light);background:transparent;color:var(--gray-light);cursor:pointer;transition:all 0.2s;">NSFW</button>
                        <button type="button" class="tag-toggle" data-tag="Sketch" onclick="this.classList.toggle('selected')" style="font-family:var(--font-body);font-size:0.8rem;padding:0.4rem 0.9rem;border-radius:20px;border:1px solid var(--border-light);background:transparent;color:var(--gray-light);cursor:pointer;transition:all 0.2s;">Sketch</button>
                        <button type="button" class="tag-toggle" data-tag="Commissions" onclick="this.classList.toggle('selected')" style="font-family:var(--font-body);font-size:0.8rem;padding:0.4rem 0.9rem;border-radius:20px;border:1px solid var(--border-light);background:transparent;color:var(--gray-light);cursor:pointer;transition:all 0.2s;">Commissions</button>
                        <button type="button" class="tag-toggle" data-tag="Animation" onclick="this.classList.toggle('selected')" style="font-family:var(--font-body);font-size:0.8rem;padding:0.4rem 0.9rem;border-radius:20px;border:1px solid var(--border-light);background:transparent;color:var(--gray-light);cursor:pointer;transition:all 0.2s;">Animation</button>
                        <button type="button" class="tag-toggle" data-tag="Fanart" onclick="this.classList.toggle('selected')" style="font-family:var(--font-body);font-size:0.8rem;padding:0.4rem 0.9rem;border-radius:20px;border:1px solid var(--border-light);background:transparent;color:var(--gray-light);cursor:pointer;transition:all 0.2s;">Fanart</button>
                        <button type="button" class="tag-toggle" data-tag="OC" onclick="this.classList.toggle('selected')" style="font-family:var(--font-body);font-size:0.8rem;padding:0.4rem 0.9rem;border-radius:20px;border:1px solid var(--border-light);background:transparent;color:var(--gray-light);cursor:pointer;transition:all 0.2s;">OC</button>
                        <button type="button" class="tag-toggle" data-tag="WIP" onclick="this.classList.toggle('selected')" style="font-family:var(--font-body);font-size:0.8rem;padding:0.4rem 0.9rem;border-radius:20px;border:1px solid var(--border-light);background:transparent;color:var(--gray-light);cursor:pointer;transition:all 0.2s;">WIP</button>
                    </div>
                    <label>Custom Tag (optional)</label>
                    <input type="text" id="new-post-custom-tag" style="width:100%;max-width:200px;margin-bottom:0.75rem;" placeholder="e.g. collab">
                    <label>Pin this post?</label>
                    <select id="new-post-pinned" style="max-width:150px;margin-bottom:0.75rem;">
                        <option value="false">No</option>
                        <option value="true">Yes</option>
                    </select>
                    <br>
                    <button class="action-btn" onclick="createPost()" style="width:100%;">Post & Save</button>
                </div>

                <!-- â”€â”€ MANAGE POSTS TAB â”€â”€ -->
                <div id="admin-tab-manage" class="admin-tab" style="display:none;">
                    <h3>Manage Existing Posts</h3>
                    <div id="manage-posts-list"></div>
                </div>

                <!-- â”€â”€ SITE SETTINGS TAB â”€â”€ -->
                <div id="admin-tab-settings" class="admin-tab" style="display:none;">
                    <h3>System Configuration</h3>

                    <!-- SYNC STATUS -->
                    <div style="padding:1rem;background:var(--bg-elevated);border:2px solid var(--lime);border-radius:var(--radius-sm);margin-bottom:1.5rem;">
                        <h4 style="margin-top:0 !important;color:var(--lime) !important;border:none !important;">ðŸ”— Auto-Sync Status</h4>
                        <p style="font-family:var(--font-mono);font-size:0.68rem;color:var(--gray-light);line-height:1.6;">
                            Posts and settings auto-sync to your Neocities site via the LBM bridge.<br>
                            Your API key is encrypted into a Secure Token â€” it's never stored as plain text.
                        </p>
                        <div id="sync-status-display" style="font-family:var(--font-mono);font-size:0.65rem;margin-top:0.5rem;color:var(--lime);">Token Loaded âœ“</div>
                    </div>

                    <h4>SEO & Metadata</h4>
                    <label>Window Title</label>
                    <input type="text" id="settings-window-title" style="max-width:400px;display:block;margin-bottom:0.5rem;">
                    <label>Meta Description</label>
                    <input type="text" id="settings-meta-desc" style="max-width:400px;display:block;margin-bottom:1rem;">

                    <h4>Visual Customization</h4>
                    <label>Site Name</label><input type="text" id="settings-sitename" style="max-width:300px;display:block;margin-bottom:0.5rem;">
                    <label>Tagline</label><input type="text" id="settings-tagline" style="max-width:300px;display:block;margin-bottom:0.5rem;">
                    <label>Posts Tab Name</label><input type="text" id="settings-posts-tab" style="max-width:200px;display:block;margin-bottom:0.5rem;">
                    <label>Copyright</label><input type="text" id="settings-copyright" style="max-width:300px;display:block;margin-bottom:0.5rem;">
                    <label>PFP URL</label><input type="text" id="settings-pfp" style="max-width:400px;display:block;margin-bottom:0.5rem;">
                    <label>Banner URL</label><input type="text" id="settings-banner" style="max-width:400px;display:block;margin-bottom:0.5rem;">
                    <label>About Text</label>
                    <textarea id="settings-about-text" rows="4" style="width:100%;margin-bottom:0.5rem;" placeholder="Write about yourself..."></textarea>

                    <h4>Colors & Theme</h4>
                    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:0.5rem;margin-bottom:1rem;">
                        <div><label>Bg</label><input type="color" id="settings-bg"></div>
                        <div><label>Text</label><input type="color" id="settings-text"></div>
                        <div><label>Sidebar</label><input type="color" id="settings-sidebar"></div>
                        <div><label>Accent</label><input type="color" id="settings-accent"></div>
                        <div><label>Post Bg</label><input type="color" id="settings-post-bg"></div>
                        <div><label>Borders</label><input type="color" id="settings-borders"></div>
                        <div><label>Active Nav</label><input type="color" id="settings-nav-active"></div>
                    </div>

                    <h4>Interaction Settings</h4>
                    <label>Enable?</label>
                    <select id="settings-reactions" style="max-width:100px;display:block;margin-bottom:0.5rem;">
                        <option value="true">Yes</option>
                        <option value="false">No</option>
                    </select>
                    <label>Icon Style</label>
                    <select id="settings-icon-style" style="max-width:150px;display:block;margin-bottom:0.5rem;">
                        <option value="faces">Faces</option>
                        <option value="thumbs">Thumbs</option>
                        <option value="arrows">Arrows</option>
                    </select>
                    <label>Like Label</label><input type="text" id="settings-like-label" style="max-width:150px;display:block;margin-bottom:0.5rem;">
                    <label>Dislike Label</label><input type="text" id="settings-dislike-label" style="max-width:150px;display:block;margin-bottom:0.5rem;">
                    <label>Like Color</label><input type="color" id="settings-like-color">
                    <label>Dislike Color</label><input type="color" id="settings-dislike-color">
                    <label>Like Text</label><input type="color" id="settings-like-btn">
                    <label>Dislike Text</label><input type="color" id="settings-dislike-btn">
                    <label>Widget Padding</label><input type="text" id="settings-widget-padding" style="max-width:150px;display:block;margin-bottom:0.5rem;">
                    <label>Global Background Image</label><input type="text" id="settings-bg-image" style="max-width:400px;display:block;margin-bottom:0.5rem;">
                    <label>Comments</label>
                    <select id="settings-comments" style="max-width:100px;display:block;margin-bottom:0.5rem;">
                        <option value="true">Yes</option>
                        <option value="false">No</option>
                    </select>
                    <label>Custom CSS</label>
                    <textarea id="settings-custom-css" rows="4" style="width:100%;margin-bottom:1rem;"></textarea>

                    <!-- Token Rotation -->
                    <div style="border-top:1px dotted var(--border);padding-top:1rem;margin-bottom:1rem;">
                        <label>Update API Key (Optional â€” rotates your Secure Token)</label>
                        <input type="password" id="edit-neocities-key" class="setup-input" placeholder="Enter new key to rotate token" autocomplete="off">
                    </div>

                    <button class="action-btn" onclick="saveSettings()" style="width:100%;max-width:300px;">Save Settings & Sync</button>
                </div>

                <!-- â•â•â•â•â•â•â•â• BANNER CUSTOMIZATION TAB â•â•â•â•â•â•â•â• -->
                <div id="admin-tab-banner-settings" class="admin-tab" style="display:none;">
                    <h3>Animated Banner Settings</h3>
                    <p style="font-family:var(--font-mono);font-size:0.7rem;color:var(--gray);margin-bottom:1rem;">
                        Customize the scrolling marquee banner below the nav bar. One item per line.
                    </p>

                    <label>Banner Text (one item per line)</label>
                    <textarea id="banner-text-input" rows="6" style="width:100%;max-width:500px;margin-bottom:1rem;" placeholder="ART WEEKLY
SFW ART
NSFW ART
DIGITAL ART
ANIMATION"></textarea>

                    <label>Scroll Speed (seconds â€” lower = faster)</label>
                    <div style="display:flex;align-items:center;gap:0.75rem;margin-bottom:1rem;">
                        <input type="range" id="banner-speed-range" min="5" max="60" value="20" 
                               oninput="document.getElementById('banner-speed-value').textContent = this.value + 's'; previewBanner();"
                               style="flex:1;max-width:300px;accent-color:var(--lime);">
                        <span id="banner-speed-value" style="font-family:var(--font-mono);font-size:0.85rem;color:var(--lime);min-width:40px;">20s</span>
                    </div>

                    <label>Banner Background Color</label>
                    <input type="color" id="banner-bg-color" value="#ff6b35" style="margin-bottom:1rem;" oninput="previewBanner()">

                    <label>Banner Text Color</label>
                    <input type="color" id="banner-text-color" value="#0d0d0d" style="margin-bottom:1rem;" oninput="previewBanner()">

                    <label>Separator Symbol</label>
                    <input type="text" id="banner-separator" style="max-width:100px;display:block;margin-bottom:1rem;" value="âœ¦" placeholder="âœ¦">

                    <label>Show Banner?</label>
                    <select id="banner-visible" style="max-width:120px;display:block;margin-bottom:1.5rem;" onchange="previewBanner()">
                        <option value="true">Yes</option>
                        <option value="false">No</option>
                    </select>

                    <div style="margin-bottom:1.5rem;">
                        <p style="font-family:var(--font-mono);font-size:0.65rem;color:var(--gray);margin-bottom:0.5rem;text-transform:uppercase;">Live Preview:</p>
                        <div id="banner-preview" style="overflow:hidden;border-radius:var(--radius-sm);border:1px solid var(--border);padding:0.5rem 0;background:var(--orange);">
                            <div style="display:flex;animation:marquee-scroll 20s linear infinite;white-space:nowrap;">
                                <span style="font-family:var(--font-display);font-size:0.85rem;letter-spacing:0.15em;color:var(--bg-dark);padding:0 1.2rem;">ART WEEKLY âœ¦</span>
                                <span style="font-family:var(--font-display);font-size:0.85rem;letter-spacing:0.15em;color:var(--bg-dark);padding:0 1.2rem;">SFW ART âœ¦</span>
                                <span style="font-family:var(--font-display);font-size:0.85rem;letter-spacing:0.15em;color:var(--bg-dark);padding:0 1.2rem;">NSFW ART âœ¦</span>
                            </div>
                        </div>
                    </div>

                    <div style="display:flex;gap:0.5rem;">
                        <button class="action-btn" onclick="applyBannerSettings()">Apply & Save</button>
                        <button class="btn-secondary" onclick="previewBanner()">Preview</button>
                    </div>
                </div>

                <!-- â•â•â•â•â•â•â•â• SOCIAL LINKS TAB â•â•â•â•â•â•â•â• -->
                <div id="admin-tab-social" class="admin-tab" style="display:none;">
                    <h3>Social Media Links</h3>
                    <p style="font-family:var(--font-mono);font-size:0.7rem;color:var(--gray);margin-bottom:1rem;">
                        These links appear on your About page.
                    </p>
                    <div id="social-links-editor"></div>
                    <button class="btn-secondary" onclick="addSocialRow('','','')" style="margin-top:0.5rem;">+ Add Link</button>
                    <br><br>
                    <button class="action-btn" onclick="saveSocialLinks()">Save Social Links</button>
                </div>

            </div>
        </section>

    </main>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• FOOTER â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <footer>
        <div class="footer-links">
            <a href="#" onclick="switchTab('posts')">Home</a>
            <a href="#" onclick="switchTab('commissions')">Commission ToS</a>
            <span style="font-family:var(--font-mono);font-size:0.55rem;color:var(--gray-dim);">
                Built on <a href="https://lbm-test.neocities.org" target="_blank" style="color:var(--gray-dim);">LBM</a>
            </span>
        </div>
        <div class="footer-copy" id="footer-copyright">Â© 2026 Artist Blog</div>
    </footer>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• LIGHTBOX â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="leaflet-lightbox" class="lightbox" style="display:none;" onclick="if(event.target === this) closeLightbox()">
        <div class="lightbox-content">
            <span class="close-btn" onclick="closeLightbox()">&times;</span>
            <div id="lightbox-body"></div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• MEDIA VIEWER â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="media-fullscreen-overlay" class="media-overlay" style="display:none;" onclick="closeMediaViewer()">
        <span class="close-media-btn" onclick="closeMediaViewer()">&times;</span>
        <button class="media-nav-btn media-prev" onclick="event.stopPropagation();mediaViewerPrev()">&#8249;</button>
        <div id="media-content-wrapper" onclick="event.stopPropagation()"></div>
        <button class="media-nav-btn media-next" onclick="event.stopPropagation();mediaViewerNext()">&#8250;</button>
        <div class="media-counter" id="media-counter"></div>
    </div>

    <!-- Scroll to top -->
    <button class="scroll-top-btn" id="scroll-top-btn" onclick="window.scrollTo({top:0,behavior:'smooth'})">â†‘</button>


    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         V4.0 SCRIPTS â€” UI Layer
         Pill Nav + Scroll Velocity + Staggered Menu
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <script>

    const PLATFORM_ICONS = {
        'twitter': 'ð•', 'x': 'ð•', 'instagram': 'ðŸ“¸', 'bluesky': 'ðŸ¦‹',
        'tumblr': 'ðŸ“', 'youtube': 'â–¶', 'tiktok': 'â™ª', 'deviantart': 'ðŸŽ¨',
        'pixiv': 'ðŸ…¿', 'twitch': 'ðŸ“º', 'ko-fi': 'â˜•', 'patreon': 'ðŸŽ­',
        'discord': 'ðŸ’¬', 'threads': 'ðŸ§µ', 'cara': 'ðŸ–¼', 'other': 'ðŸ”—'
    };

    const PLATFORM_OPTIONS = [
        'Twitter/X', 'Instagram', 'Bluesky', 'Tumblr', 'YouTube', 'TikTok',
        'DeviantArt', 'Pixiv', 'Twitch', 'Ko-fi', 'Patreon', 'Discord', 'Threads', 'Cara', 'Other'
    ];

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PILL NAV â€” Sliding indicator
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    function updatePillIndicator() {
        const navCenter = document.getElementById('nav-center');
        const pill = document.getElementById('pill-indicator');
        if (!navCenter || !pill) return;
        const activeBtn = navCenter.querySelector('.nav-link.active');
        if (!activeBtn) { pill.style.opacity = '0'; return; }
        const navRect = navCenter.getBoundingClientRect();
        const btnRect = activeBtn.getBoundingClientRect();
        pill.style.opacity = '1';
        pill.style.left = (btnRect.left - navRect.left) + 'px';
        pill.style.width = btnRect.width + 'px';
    }

    /* â”€â”€ Tab switching â”€â”€ */
    function switchTab(tab, btn) {
        document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-center .nav-link, .nav-right .nav-link, .mobile-menu .nav-link').forEach(b => b.classList.remove('active'));
        const section = document.getElementById('section-' + tab);
        if (section) section.classList.add('active');
        if (btn && btn.classList.contains('nav-link')) btn.classList.add('active');
        const centerButtons = document.querySelectorAll('.nav-center .nav-link');
        const tabMap = { 'posts': 'Home', 'about': 'About', 'gallery': 'Gallery', 'commissions': 'Commissions' };
        centerButtons.forEach(b => { if (b.textContent.trim() === tabMap[tab]) b.classList.add('active'); });
        requestAnimationFrame(updatePillIndicator);
        closeMobileMenu();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    /* â”€â”€ Mobile menu â”€â”€ */
    function toggleMobileMenu() {
        const menu = document.getElementById('mobile-menu');
        if (menu.classList.contains('open')) { closeMobileMenu(); }
        else {
            const links = menu.querySelectorAll('.nav-link');
            links.forEach(l => { l.style.animation = 'none'; });
            menu.style.display = 'flex';
            menu.classList.add('open');
            requestAnimationFrame(() => { links.forEach(l => { l.style.animation = ''; }); });
        }
    }
    function closeMobileMenu() {
        const menu = document.getElementById('mobile-menu');
        menu.classList.remove('open');
        menu.style.display = 'none';
    }
    document.addEventListener('click', (e) => {
        const menu = document.getElementById('mobile-menu');
        const btn = document.querySelector('.hamburger-btn');
        if (menu.classList.contains('open') && !menu.contains(e.target) && !btn.contains(e.target)) closeMobileMenu();
    });

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SCROLL VELOCITY MARQUEE
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    (function initScrollVelocityMarquee() {
        let lastScrollY = window.scrollY, lastTime = Date.now(), velocityFactor = 1, rafId = null;
        function updateMarqueeSpeed() {
            const marquee = document.querySelector('.marquee');
            if (!marquee) return;
            const now = Date.now(), dt = Math.max(now - lastTime, 1), dy = Math.abs(window.scrollY - lastScrollY);
            const speed = dy / dt;
            lastScrollY = window.scrollY; lastTime = now;
            const targetFactor = 1 + Math.min(speed * 8, 3);
            velocityFactor += (targetFactor - velocityFactor) * 0.15;
            const baseSpeed = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--banner-speed')) || 20;
            marquee.style.animationDuration = (baseSpeed / velocityFactor) + 's';
            rafId = requestAnimationFrame(updateMarqueeSpeed);
        }
        window.addEventListener('scroll', () => { if (!rafId) rafId = requestAnimationFrame(updateMarqueeSpeed); }, { passive: true });
        setInterval(() => {
            if (velocityFactor > 1.05) {
                velocityFactor += (1 - velocityFactor) * 0.08;
                const marquee = document.querySelector('.marquee');
                if (marquee) { const bs = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--banner-speed')) || 20; marquee.style.animationDuration = (bs / velocityFactor) + 's'; }
            }
            if (rafId && velocityFactor < 1.05) { cancelAnimationFrame(rafId); rafId = null; }
        }, 100);
    })();

    /* â”€â”€ Scroll to top button â”€â”€ */
    window.addEventListener('scroll', () => {
        document.getElementById('scroll-top-btn').classList.toggle('visible', window.scrollY > 400);
    });

    /* â”€â”€ Search / filter posts â”€â”€ */
    function filterPosts() {
        const q = (document.getElementById('search-input').value || '').toLowerCase().trim();
        document.querySelectorAll('#leaflets-container .leaflet-item').forEach(post => {
            const text = (post.textContent || '').toLowerCase();
            post.style.display = !q || text.includes(q) ? '' : 'none';
        });
    }

    /* â”€â”€ Sort posts â”€â”€ */
    function sortPosts() {
        const method = document.getElementById('sort-select').value;
        const container = document.getElementById('leaflets-container');
        const posts = Array.from(container.querySelectorAll('.leaflet-item'));
        posts.sort((a, b) => {
            if (method === 'newest') return (b.dataset.timestamp || 0) - (a.dataset.timestamp || 0);
            if (method === 'oldest') return (a.dataset.timestamp || 0) - (b.dataset.timestamp || 0);
            if (method === 'popular') return (b.dataset.likes || 0) - (a.dataset.likes || 0);
            return (a.dataset.likes || 0) - (b.dataset.likes || 0);
        });
        posts.forEach(p => container.appendChild(p));
    }

    /* â”€â”€ Filter by tag â”€â”€ */
    function filterByTag(tag, btn) {
        document.querySelectorAll('.tags-bar .tag-pill').forEach(p => p.classList.remove('active'));
        if (btn) btn.classList.add('active');
        document.querySelectorAll('#leaflets-container .leaflet-item').forEach(post => {
            if (tag === 'all') { post.style.display = ''; }
            else { post.style.display = (post.dataset.tags || '').toLowerCase().includes(tag.toLowerCase()) ? '' : 'none'; }
        });
    }

    /* â”€â”€ Admin sub-tabs â”€â”€ */
    function showAdminTab(tab, btn) {
        document.querySelectorAll('.admin-tab').forEach(t => t.style.display = 'none');
        const target = document.getElementById('admin-tab-' + tab);
        if (target) target.style.display = 'block';
        if (btn) {
            const parent = btn.parentElement;
            parent.querySelectorAll('.nav-link').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
        if (tab === 'manage') renderManagePosts();
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       BANNER CUSTOMIZATION
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    function loadBannerSettings() {
        // Primary source: currentConfig (synced via system.js)
        let s = currentConfig.bannerSettings;
        // Fallback: localStorage (for migration from old versions)
        if (!s) {
            const saved = localStorage.getItem('neerg_banner_settings');
            if (saved) { try { s = JSON.parse(saved); } catch(e) {} }
        }
        if (s) {
            try {
                if (s.text) document.getElementById('banner-text-input').value = s.text;
                if (s.speed) { document.getElementById('banner-speed-range').value = s.speed; document.getElementById('banner-speed-value').textContent = s.speed + 's'; }
                if (s.bgColor) document.getElementById('banner-bg-color').value = s.bgColor;
                if (s.textColor) document.getElementById('banner-text-color').value = s.textColor;
                if (s.separator) document.getElementById('banner-separator').value = s.separator;
                if (s.visible !== undefined) document.getElementById('banner-visible').value = String(s.visible);
                applyBannerToPage(s);
            } catch(e) {}
        }
    }

    function previewBanner() { const s = getBannerFormValues(); applyBannerToPage(s); updateBannerPreview(s); }

    function getBannerFormValues() {
        const textRaw = document.getElementById('banner-text-input').value.trim();
        const items = textRaw ? textRaw.split('\n').filter(l => l.trim()) : ['ART WEEKLY', 'SFW ART', 'NSFW ART'];
        return { text: textRaw, items, speed: parseInt(document.getElementById('banner-speed-range').value) || 20,
            bgColor: document.getElementById('banner-bg-color').value || '#ff6b35', textColor: document.getElementById('banner-text-color').value || '#0d0d0d',
            separator: document.getElementById('banner-separator').value || 'âœ¦', visible: document.getElementById('banner-visible').value === 'true' };
    }

    function applyBannerToPage(settings) {
        const container = document.getElementById('marquee-container');
        const track = document.getElementById('marquee-track');
        if (!settings.visible && settings.visible !== undefined) { container.style.display = 'none'; return; }
        container.style.display = 'block';
        container.style.background = settings.bgColor || '#ff6b35';
        container.style.setProperty('--marquee-bg', settings.bgColor || '#ff6b35');
        const items = settings.items || ['ART WEEKLY', 'SFW ART', 'NSFW ART'];
        const sep = settings.separator || 'âœ¦';
        let html = '';
        for (let i = 0; i < 4; i++) { items.forEach(item => { html += `<span style="color:${settings.textColor || '#0d0d0d'}">${item.trim().toUpperCase()}</span>`; }); }
        track.innerHTML = html;
        const style = document.getElementById('banner-sep-style') || document.createElement('style');
        style.id = 'banner-sep-style';
        style.textContent = `.marquee span::after { content: '${sep}'; margin-left: 1.5rem; }`;
        if (!style.parentNode) document.head.appendChild(style);
        const spd = (settings.speed || 20) + 's';
        document.documentElement.style.setProperty('--banner-speed', spd);
        track.style.animationDuration = spd;
    }

    function updateBannerPreview(settings) {
        const preview = document.getElementById('banner-preview');
        if (!preview) return;
        const items = settings.items || ['ART WEEKLY', 'SFW ART', 'NSFW ART'];
        const sep = settings.separator || 'âœ¦';
        let spans = '';
        items.forEach(item => { spans += `<span style="font-family:var(--font-display);font-size:0.85rem;letter-spacing:0.15em;color:${settings.textColor};padding:0 1.2rem;">${item.trim().toUpperCase()} ${sep}</span>`; });
        preview.style.background = settings.bgColor;
        preview.style.display = settings.visible !== false ? 'block' : 'none';
        preview.innerHTML = `<div style="display:flex;animation:marquee-scroll ${settings.speed}s linear infinite;white-space:nowrap;">${spans}${spans}</div>`;
    }

    function applyBannerSettings() {
        const settings = getBannerFormValues();
        // Save to currentConfig (syncs via system.js to Neocities)
        currentConfig.bannerSettings = settings;
        localStorage.setItem('neerg_banner_settings', JSON.stringify(settings));
        applyBannerToPage(settings); updateBannerPreview(settings);
        saveSystem();
        showToast('Banner settings saved & syncing!');
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SOCIAL LINKS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    function loadSocialLinks() {
        // Primary source: currentConfig (synced via system.js)
        let links = currentConfig.socialLinks || [];
        // Fallback: localStorage (for migration from old versions)
        if (links.length === 0) {
            const saved = localStorage.getItem('neerg_social_links');
            if (saved) { try { links = JSON.parse(saved); } catch(e) {} }
        }
        if (links.length > 0) { renderSocialLinksDisplay(links); renderSocialLinksEditor(links); }
    }
    function renderSocialLinksDisplay(links) {
        const container = document.getElementById('social-links-display');
        if (!container || !links.length) { if(container) container.innerHTML = ''; return; }
        container.innerHTML = links.map(link => {
            const platform = link.platform.toLowerCase().replace('twitter/x', 'twitter').replace('/', '');
            const icon = PLATFORM_ICONS[platform] || 'ðŸ”—';
            return `<a class="social-link" href="${link.url}" target="_blank" data-platform="${platform}"><span class="social-icon">${icon}</span> ${link.label || link.platform}</a>`;
        }).join('');
    }
    function renderSocialLinksEditor(links) { const ed = document.getElementById('social-links-editor'); if(!ed) return; ed.innerHTML = ''; links.forEach(l => addSocialRow(l.platform, l.url, l.label)); }
    function addSocialRow(platform, url, label) {
        const editor = document.getElementById('social-links-editor');
        const row = document.createElement('div'); row.className = 'social-editor-row';
        let options = PLATFORM_OPTIONS.map(p => `<option value="${p}" ${p === platform ? 'selected' : ''}>${p}</option>`).join('');
        row.innerHTML = `<select>${options}</select><input type="text" placeholder="Display name" value="${label || ''}"><input type="text" placeholder="https://..." value="${url || ''}"><button class="btn-remove-social" onclick="this.parentElement.remove()">Ã—</button>`;
        editor.appendChild(row);
    }
    function saveSocialLinks() {
        const rows = document.querySelectorAll('#social-links-editor .social-editor-row');
        const links = [];
        rows.forEach(row => { const p = row.querySelector('select').value, l = row.querySelectorAll('input')[0].value.trim(), u = row.querySelectorAll('input')[1].value.trim(); if(u) links.push({platform:p,label:l,url:u}); });
        // Save to currentConfig (syncs via system.js to Neocities)
        currentConfig.socialLinks = links;
        localStorage.setItem('neerg_social_links', JSON.stringify(links));
        renderSocialLinksDisplay(links);
        saveSystem();
        showToast('Social links saved & syncing!');
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       DARK / LIGHT MODE TOGGLE
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    let isDarkMode = true;
    function toggleDarkLight() {
        isDarkMode = !isDarkMode;
        document.body.classList.toggle('light-mode', !isDarkMode);
        localStorage.setItem('neerg_theme', isDarkMode ? 'dark' : 'light');
        // Update toggle icon
        const toggleBtn = document.querySelector('.nav-icon-btn[title="Toggle theme"]');
        if (toggleBtn) toggleBtn.textContent = isDarkMode ? 'â˜€' : 'ðŸŒ™';
        requestAnimationFrame(updatePillIndicator);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       FEATURED CARDS CAROUSEL
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    let featuredCardIndex = 0;
    let featuredCardTimer = null;

    function populateArtScroll() {
        const section = document.getElementById('featured-cards-section');
        const track = document.getElementById('featured-cards-track');
        const dotsEl = document.getElementById('featured-cards-dots');
        if (!track || !section) return;

        let mediaPosts = [];
        if (typeof postsCache !== 'undefined' && postsCache.length > 0) {
            mediaPosts = [...postsCache]
                .filter(p => p.media && !String(p.media).match(/\.(mp4|webm|mov)$/i))
                .sort((a, b) => b.id - a.id)
                .slice(0, 5);
        }

        if (mediaPosts.length === 0) { section.style.display = 'none'; return; }
        section.style.display = 'block';

        // Build cards
        track.innerHTML = mediaPosts.map((post, i) => {
            const mediaUrl = Array.isArray(post.media) ? post.media[0] : post.media;
            const inter = (typeof interactionsCache !== 'undefined' && interactionsCache[post.id]) ? interactionsCache[post.id] : { likes: 0, dislikes: 0, comments: [] };
            const commentCount = inter.comments ? inter.comments.length : 0;
            const totalReply = inter.comments ? inter.comments.reduce((sum, c) => sum + (c.replies ? c.replies.length : 0), 0) : 0;
            const totalComments = commentCount + totalReply;
            const contentPreview = (post.content || '').substring(0, 80) + ((post.content || '').length > 80 ? '...' : '');
            const isTrending = (inter.likes + totalComments) >= 3;
            const tagStr = (post.tags && post.tags.length > 0) ? post.tags[0] : '';

            return `<div class="featured-card" data-index="${i}" onclick="openLightbox(${post.id})">
                <div class="featured-card-img">
                    <img src="${mediaUrl}" alt="" loading="lazy" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 1 1%22><rect fill=%22%23222%22 width=%221%22 height=%221%22/></svg>'">
                </div>
                <div class="featured-card-body">
                    <div class="featured-card-meta">
                        <span class="featured-card-author">NEERG</span>
                        <span class="featured-card-date">Â· ${post.date || 'Recent'}</span>
                    </div>
                    <div class="featured-card-title">${escapeHtml(contentPreview)}</div>
                    <div class="featured-card-stats">
                        <span class="fc-stat"><span class="fc-icon">â–²</span> ${inter.likes || 0}</span>
                        <span class="fc-stat"><span class="fc-icon">ðŸ’¬</span> ${totalComments}</span>
                        ${isTrending ? '<span class="fc-trending">â— Trending</span>' : ''}
                        ${tagStr ? '<span class="fc-tag">' + escapeHtml(tagStr) + '</span>' : ''}
                    </div>
                </div>
            </div>`;
        }).join('');

        // Build dots
        dotsEl.innerHTML = mediaPosts.map((_, i) =>
            `<button class="fc-dot${i === 0 ? ' active' : ''}" onclick="goToFeaturedCard(${i})"></button>`
        ).join('');

        featuredCardIndex = 0;
        startFeaturedCardTimer();
    }

    function goToFeaturedCard(index) {
        const track = document.getElementById('featured-cards-track');
        const cards = track.querySelectorAll('.featured-card');
        const dots = document.querySelectorAll('.fc-dot');
        if (cards.length === 0) return;

        featuredCardIndex = index;
        if (featuredCardIndex >= cards.length) featuredCardIndex = 0;
        if (featuredCardIndex < 0) featuredCardIndex = cards.length - 1;

        // Scroll to card
        const card = cards[featuredCardIndex];
        track.scrollTo({ left: card.offsetLeft - track.offsetLeft, behavior: 'smooth' });

        // Update dots
        dots.forEach((d, i) => d.classList.toggle('active', i === featuredCardIndex));

        // Reset timer
        startFeaturedCardTimer();
    }

    function startFeaturedCardTimer() {
        if (featuredCardTimer) clearInterval(featuredCardTimer);
        featuredCardTimer = setInterval(() => {
            const track = document.getElementById('featured-cards-track');
            if (!track) return;
            const total = track.querySelectorAll('.featured-card').length;
            if (total === 0) return;
            goToFeaturedCard((featuredCardIndex + 1) % total);
        }, 5000); // Auto-advance every 5 seconds
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SCROLL REVEAL ANIMATION
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    function initScrollReveal() {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => { if (entry.isIntersecting) entry.target.classList.add('revealed'); });
        }, { threshold: 0.1, rootMargin: '0px 0px -50px 0px' });
        const watchForPosts = new MutationObserver(() => {
            document.querySelectorAll('.leaflet-item:not(.reveal-on-scroll)').forEach(post => { post.classList.add('reveal-on-scroll'); observer.observe(post); });
            populateArtScroll();
        });
        const container = document.getElementById('leaflets-container');
        if (container) watchForPosts.observe(container, { childList: true, subtree: true });
    }

    </script>


    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         LBM CORE ENGINE â€” Adapted for V4.0
         Handles: posts, gallery, admin, reactions, comments
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <script>

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       UTILITIES
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    function unicodeToBase64(str) { return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (m, p1) => String.fromCharCode('0x' + p1))); }
    function base64ToUnicode(str) { return decodeURIComponent(atob(str).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')); }
    async function sha256(message) {
        const msgBuffer = new TextEncoder().encode(message);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
        return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    function downloadFile(content, name) {
        const link = document.createElement("a");
        link.href = URL.createObjectURL(new Blob([content], { type: "text/plain" }));
        link.download = name;
        document.body.appendChild(link); link.click(); document.body.removeChild(link);
    }

    function getMediaType(url) {
        if (!url) return 'none';
        if (url.match(/\.(mp4|webm|mov)$/i)) return 'video';
        return 'image';
    }

    function showToast(msg, type = 'success') {
        const t = document.createElement('div');
        t.style.cssText = `font-family:var(--font-mono);font-size:0.78rem;padding:0.75rem 1.5rem;background:var(--bg-card);border:1px solid ${type === 'error' ? 'var(--pink)' : 'var(--lime)'};color:${type === 'error' ? 'var(--pink)' : 'var(--lime)'};border-radius:var(--radius-pill);z-index:9999;animation:fadeIn 0.3s ease;`;
        t.textContent = msg;
        document.getElementById('toast-container').appendChild(t);
        if (type === 'loading') {
            currentLoadingToast = t;
        } else {
            setTimeout(() => { t.style.opacity = '0'; t.style.transition = 'opacity 0.5s'; setTimeout(() => t.remove(), 500); }, 3000);
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.appendChild(document.createTextNode(text));
        return div.innerHTML;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       STATE
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    let postsCache = [];
    let interactionsCache = {};
    let globalAdminHash = null;
    let globalSalt = null;
    let globalAuthToken = null;
    let globalApiKey = null;
    let sessionPassword = null;
    let isAdminLoggedIn = false;
    let currentLoadingToast = null;
    const FIXED_BRIDGE_URL = "https://applchu.link/lbm/0.4/bridge.html?v=" + new Date().getTime();
    const LOCAL_REACTIONS_KEY = 'NEERG_USER_REACTIONS';
    const LOCAL_STORAGE_KEY = 'NEERG_CONFIG_CACHE';
    const POSTS_PER_PAGE = 12;
    let currentPage = 1;

    let currentConfig = {
        siteName: "NEERG",
        metaTitle: "NEERG // Art Blog",
        metaDescription: "Digital art archive by NEERG",
        tagline: "Digital Art Archive",
        leafletsName: "Works",
        allowComments: true,
        copyright: "2025 NEERG",
        bgImage: "", bannerImage: "", pfpImage: "", customCss: "",
        reactionsEnabled: true,
        reactionIcon: "thumb",
        likeLabel: "â—ˆ NICE",
        dislikeLabel: "MEH â—ˆ",
        widgetPadding: "15px",
        socialLinks: [],
        bannerSettings: null,
        aboutBio: "",
        colors: {
            bg: "#0a0a0a", text: "#f0f0f0", sidebar: "#111111", accent: "#ff6b35",
            leaflet: "#191515", border: "#333333", navActive: "#c8ff00",
            like: "#c8ff00", dislike: "#ff3c8e", likeBtn: "#0a0a0a", dislikeBtn: "#0a0a0a"
        }
    };

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SYSTEM DATA PARSING
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    function parseSystemData() {
        // Parse interactions from server file (authoritative source)
        if (typeof window.AZUMINT_INTERACTIONS !== 'undefined') {
            try {
                interactionsCache = JSON.parse(base64ToUnicode(window.AZUMINT_INTERACTIONS));
                // Update localStorage backup to match fresh server data
                localStorage.setItem('NEERG_INTERACTIONS_BACKUP', JSON.stringify(interactionsCache));
            }
            catch(e) { console.error("Interactions parse error", e); }
        }

        // Parse system config
        if (typeof window.AZUMINT_SYSTEM === 'undefined') {
            console.log("No system.js found â€” showing setup wizard");
            showSetup();
            return;
        }

        try {
            const data = JSON.parse(base64ToUnicode(window.AZUMINT_SYSTEM));
            globalAdminHash = data.adminHash;
            globalSalt = data.salt;
            postsCache = data.posts || [];

            // Extract auth token and API key from the original LBM bridge system
            if (data.authToken) globalAuthToken = data.authToken;
            if (data.apiKey) globalApiKey = data.apiKey;

            if (data.siteConfig) {
                currentConfig = {
                    ...currentConfig,
                    ...data.siteConfig,
                    colors: { ...currentConfig.colors, ...(data.siteConfig.colors || {}) }
                };
            }

            hideSetup();
            applyVisualConfig();
            renderLeaflets();
            renderGallery();
            populateArtScroll();

            // Handle permalink
            if (window.location.hash) {
                const id = parseInt(window.location.hash.substring(1));
                if (!isNaN(id)) setTimeout(() => openLightbox(id), 500);
            }
        } catch(e) {
            console.error("Config parse error", e);
            showToast("Error reading system.js â€” try re-uploading", "error");
        }
    }

    function showSetup() { document.getElementById('setup-wizard').style.display = 'block'; }
    function hideSetup() { document.getElementById('setup-wizard').style.display = 'none'; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       APPLY VISUAL CONFIG
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    function applyVisualConfig() {
        if (currentConfig.metaTitle) document.title = currentConfig.metaTitle;
        const metaDesc = document.querySelector('meta[name="description"]');
        if (metaDesc && currentConfig.metaDescription) metaDesc.setAttribute('content', currentConfig.metaDescription);

        document.getElementById('nav-sitename').textContent = currentConfig.siteName || 'Artist Blog';
        document.getElementById('about-name').textContent = currentConfig.siteName || 'NEERG';
        if (currentConfig.tagline) document.getElementById('about-tagline').textContent = currentConfig.tagline;
        if (currentConfig.copyright) document.getElementById('footer-copyright').textContent = 'Â© ' + currentConfig.copyright;

        const postsTitle = document.getElementById('posts-title');
        if (postsTitle && currentConfig.leafletsName) postsTitle.textContent = 'Recent ' + currentConfig.leafletsName;

        // PFP
        if (currentConfig.pfpImage && currentConfig.pfpImage.length > 5) {
            const navPfp = document.getElementById('nav-pfp');
            navPfp.src = currentConfig.pfpImage; navPfp.style.display = 'block';
            const aboutPfp = document.getElementById('about-pfp');
            aboutPfp.src = currentConfig.pfpImage; aboutPfp.style.display = 'block';
        }

        // About bio â€” primary source: currentConfig (synced), fallback: localStorage
        const aboutBioText = currentConfig.aboutBio || localStorage.getItem('neerg_about_bio');
        if (aboutBioText) document.getElementById('about-bio').textContent = aboutBioText;

        // Colors
        const r = document.documentElement.style;
        const c = currentConfig.colors;
        r.setProperty('--background-color', c.bg); r.setProperty('--text-color', c.text);
        r.setProperty('--sidebar-bg', c.sidebar); r.setProperty('--accent-color', c.accent);
        r.setProperty('--leaflet-bg', c.leaflet); r.setProperty('--border-color', c.border);
        r.setProperty('--nav-active-color', c.navActive); r.setProperty('--like-color', c.like);
        r.setProperty('--dislike-color', c.dislike); r.setProperty('--like-btn-color', c.likeBtn);
        r.setProperty('--dislike-btn-color', c.dislikeBtn); r.setProperty('--widget-padding', currentConfig.widgetPadding);

        if (currentConfig.bgImage && currentConfig.bgImage.length > 5) r.setProperty('--bg-image', `url('${currentConfig.bgImage}')`);
        else r.setProperty('--bg-image', 'none');

        // Custom CSS
        let customStyle = document.getElementById('custom-css-block');
        if (!customStyle) { customStyle = document.createElement('style'); customStyle.id = 'custom-css-block'; document.head.appendChild(customStyle); }
        customStyle.textContent = currentConfig.customCss || '';

        // Reload social links and banner from currentConfig (now populated from system.js)
        loadSocialLinks();
        loadBannerSettings();
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       RENDER POSTS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    function renderLeaflets() {
        const container = document.getElementById('leaflets-container');
        if (!container) return;

        if (postsCache.length === 0) {
            container.innerHTML = '<p style="font-family:var(--font-mono);font-size:0.8rem;color:var(--gray);text-align:center;padding:3rem 1rem;grid-column:1/-1;">No posts yet. Log in to the admin panel to create your first post!</p>';
            return;
        }

        let posts = [...postsCache];
        // Sort: pinned first, then by id (newest first)
        posts.sort((a, b) => {
            if (a.pinned && !b.pinned) return -1;
            if (!a.pinned && b.pinned) return 1;
            return b.id - a.id;
        });

        // Pagination
        const totalPages = Math.ceil(posts.length / POSTS_PER_PAGE);
        const start = (currentPage - 1) * POSTS_PER_PAGE;
        const pagePosts = posts.slice(start, start + POSTS_PER_PAGE);

        let userReactions = {};
        try { userReactions = JSON.parse(localStorage.getItem(LOCAL_REACTIONS_KEY) || '{}'); } catch(e) {}

        container.innerHTML = pagePosts.map(post => {
            const ints = interactionsCache[post.id] || { likes: 0, dislikes: 0, comments: [] };
            const likes = ints.likes || 0;
            const dislikes = ints.dislikes || 0;
            const commentCount = (ints.comments || []).length;
            const total = likes + dislikes;
            const ratio = total === 0 ? 50 : (likes / total) * 100;

            let [lTxt, dTxt] = [currentConfig.likeLabel || '(ï¼¾âˆ‡ï¼¾)', currentConfig.dislikeLabel || '(ï¼›ã¸ï¼š)'];
            if (currentConfig.reactionIcon === 'thumb' || currentConfig.reactionIcon === 'thumbs') [lTxt, dTxt] = ['ðŸ‘', 'ðŸ‘Ž'];
            if (currentConfig.reactionIcon === 'arrow' || currentConfig.reactionIcon === 'arrows') [lTxt, dTxt] = ['â–²', 'â–¼'];

            const myAction = userReactions[post.id];
            const likeVoted = myAction === 'like' ? 'voted' : '';
            const dislikeVoted = myAction === 'dislike' ? 'voted' : '';

            const date = post.date || new Date(post.id).toLocaleDateString();
            const tags = (post.tags || []).join(', ');
            const tagsData = (post.tags || []).join(',').toLowerCase();

            let contentHtml = post.content || '';
            if (typeof marked !== 'undefined') {
                try { contentHtml = marked.parse(contentHtml); } catch(e) { contentHtml = post.content; }
            }

            let mediaHtml = '';
            if (post.media) {
                let mediaArray = Array.isArray(post.media) ? post.media : [post.media];
                mediaHtml = mediaArray.map(url => {
                    if (getMediaType(url) === 'video') return `<div class="leaflet-media-container"><video src="${url}" muted loop playsinline preload="metadata" onmouseover="this.play()" onmouseout="this.pause()"></video></div>`;
                    return `<div class="leaflet-media-container"><img src="${url}" alt="Media" loading="lazy" onerror="this.parentElement.style.display='none'"></div>`;
                }).join('');
            }

            let reactionsHtml = '';
            if (currentConfig.reactionsEnabled) {
                reactionsHtml = `
                    <div class="reaction-widget">
                        <button class="reaction-btn like-btn ${likeVoted}" onclick="event.stopPropagation();reactTo(${post.id},'like')">${lTxt} ${likes}</button>
                        <div class="reaction-bar"><div class="reaction-fill" style="width:${ratio}%"></div></div>
                        <button class="reaction-btn dislike-btn ${dislikeVoted}" onclick="event.stopPropagation();reactTo(${post.id},'dislike')">${dTxt} ${dislikes}</button>
                        <span class="comment-count" onclick="event.stopPropagation();openLightbox(${post.id})">ðŸ’¬ ${commentCount}</span>
                    </div>`;
            }

            const pinnedBadge = post.pinned ? '<span style="font-family:var(--font-mono);font-size:0.55rem;color:var(--orange);text-transform:uppercase;letter-spacing:0.05em;">ðŸ“Œ Pinned</span>' : '';
            const deleteBtn = isAdminLoggedIn ? `<button class="delete-btn" onclick="event.stopPropagation();deletePost(${post.id})" title="Delete post">ðŸ—‘</button>` : '';

            return `<div class="leaflet-item" data-id="${post.id}" data-timestamp="${post.id}" data-likes="${likes}" data-tags="${tagsData}" onclick="openLightbox(${post.id})">
                ${mediaHtml}
                <div class="leaflet-body">
                    <div class="leaflet-header">
                        <span class="leaflet-author">${escapeHtml(currentConfig.siteName)}</span>
                        <span>Â· ${date}</span>
                        ${pinnedBadge}
                        ${deleteBtn}
                    </div>
                    <div class="leaflet-content">${contentHtml}</div>
                    ${tags ? `<div style="font-family:var(--font-mono);font-size:0.62rem;color:var(--gray);">${tags}</div>` : ''}
                    ${reactionsHtml}
                </div>
            </div>`;
        }).join('');

        // Render pagination
        renderPagination(totalPages);
    }

    function renderPagination(totalPages) {
        const pag = document.getElementById('pagination');
        if (!pag || totalPages <= 1) { if(pag) pag.innerHTML = ''; return; }
        let html = '';
        if (currentPage > 1) html += `<button class="page-btn" onclick="goToPage(${currentPage - 1})">â€¹</button>`;
        for (let i = 1; i <= totalPages; i++) {
            html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
        }
        if (currentPage < totalPages) html += `<button class="page-btn" onclick="goToPage(${currentPage + 1})">â€º</button>`;
        pag.innerHTML = html;
    }

    function goToPage(page) {
        currentPage = page;
        renderLeaflets();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       RENDER GALLERY
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    function renderGallery() {
        const container = document.getElementById('gallery-container');
        if (!container) return;
        const mediaPosts = postsCache.filter(p => p.media);
        if (mediaPosts.length === 0) { container.innerHTML = '<p style="font-family:var(--font-mono);font-size:0.8rem;color:var(--gray);">No images yet.</p>'; return; }
        container.innerHTML = mediaPosts.sort((a,b) => b.id - a.id).map(post => {
            let mediaArray = Array.isArray(post.media) ? post.media : [post.media];
            return mediaArray.map(url => {
                if (getMediaType(url) === 'video') return `<div class="gallery-item" onclick="openMediaViewer('${url}','video')"><video src="${url}" muted loop playsinline preload="metadata" onmouseover="this.play()" onmouseout="this.pause()"></video></div>`;
                return `<div class="gallery-item" onclick="openMediaViewer('${url}','image')"><img src="${url}" alt="Gallery" loading="lazy" onerror="this.parentElement.style.display='none'"></div>`;
            }).join('');
        }).join('');
        buildGalleryMediaList();
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       REACTIONS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    function reactTo(postId, type) {
        if (!interactionsCache[postId]) interactionsCache[postId] = { likes: 0, dislikes: 0, comments: [] };
        let userReactions = {};
        try { userReactions = JSON.parse(localStorage.getItem(LOCAL_REACTIONS_KEY) || '{}'); } catch(e) {}
        const current = userReactions[postId];

        if (current === type) {
            // Undo
            interactionsCache[postId][type + 's'] = Math.max(0, (interactionsCache[postId][type + 's'] || 0) - 1);
            delete userReactions[postId];
            showToast('Vote removed');
        } else {
            if (current) interactionsCache[postId][current + 's'] = Math.max(0, (interactionsCache[postId][current + 's'] || 0) - 1);
            interactionsCache[postId][type + 's'] = (interactionsCache[postId][type + 's'] || 0) + 1;
            userReactions[postId] = type;
            showToast('Vote recorded!');
        }
        localStorage.setItem(LOCAL_REACTIONS_KEY, JSON.stringify(userReactions));
        renderLeaflets();
        saveInteractionsLocal();
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       LIGHTBOX
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    function openLightbox(postId) {
        const post = postsCache.find(p => p.id === postId);
        if (!post) return;
        const body = document.getElementById('lightbox-body');
        const ints = interactionsCache[postId] || { likes: 0, dislikes: 0, comments: [] };
        const comments = ints.comments || [];
        const likes = ints.likes || 0, dislikes = ints.dislikes || 0;

        let userReactions = {};
        try { userReactions = JSON.parse(localStorage.getItem(LOCAL_REACTIONS_KEY) || '{}'); } catch(e) {}
        const myAction = userReactions[postId];
        const total = likes + dislikes;
        const ratio = total === 0 ? 50 : (likes / total) * 100;

        let [lTxt, dTxt] = [currentConfig.likeLabel || '(ï¼¾âˆ‡ï¼¾)', currentConfig.dislikeLabel || '(ï¼›ã¸ï¼š)'];
        if (currentConfig.reactionIcon === 'thumb' || currentConfig.reactionIcon === 'thumbs') [lTxt, dTxt] = ['ðŸ‘', 'ðŸ‘Ž'];
        if (currentConfig.reactionIcon === 'arrow' || currentConfig.reactionIcon === 'arrows') [lTxt, dTxt] = ['â–²', 'â–¼'];

        let contentHtml = post.content || '';
        if (typeof marked !== 'undefined') try { contentHtml = marked.parse(contentHtml); } catch(e) {}

        let mediaHtml = '';
        if (post.media) {
            let arr = Array.isArray(post.media) ? post.media : [post.media];
            mediaHtml = arr.map(url => {
                if (getMediaType(url) === 'video') return `<video controls autoplay loop muted playsinline style="width:100%;border-radius:var(--radius-lg);margin-bottom:1rem;cursor:pointer;" onclick="openMediaViewer('${url}','video')"><source src="${url}"></video>`;
                return `<img src="${url}" alt="Media" style="width:100%;border-radius:var(--radius-lg);margin-bottom:1rem;cursor:pointer;" onclick="openMediaViewer('${url}','image')" onerror="this.style.display='none'">`;
            }).join('');
        }

        const date = post.date || new Date(post.id).toLocaleDateString();
        const tags = (post.tags || []).map(t => `<span style="font-family:var(--font-mono);font-size:0.62rem;color:var(--gray);background:var(--bg-elevated);padding:0.2rem 0.5rem;border-radius:var(--radius-pill);">${t}</span>`).join(' ');

        let commentsHtml = '';
        if (currentConfig.allowComments) {
            const commentItems = comments.map(c => {
                const isReply = c.parentId ? 'margin-left:1.5rem;border-left:2px solid var(--border);' : '';
                return `<div style="${isReply}background:var(--bg-elevated);padding:0.75rem 1rem;border-radius:var(--radius-sm);margin-bottom:0.5rem;">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.35rem;">
                        <span style="font-family:var(--font-mono);font-size:0.7rem;color:var(--orange);font-weight:500;">${escapeHtml(c.author)}</span>
                        <span style="font-family:var(--font-mono);font-size:0.6rem;color:var(--gray-dim);">${c.date}${isAdminLoggedIn ? ` <button onclick="deleteComment(${postId},${c.id})" style="background:none;border:none;color:var(--pink);cursor:pointer;font-size:0.65rem;font-family:var(--font-mono);margin-left:0.5rem;">Delete</button>` : ''}</span>
                    </div>
                    <div style="font-size:0.88rem;line-height:1.6;color:var(--gray-light);word-break:break-word;">${escapeHtml(c.text)}</div>
                    ${!c.parentId ? `<button onclick="document.getElementById('reply-to-${c.id}').style.display='block'" style="background:none;border:none;color:var(--gray);cursor:pointer;font-family:var(--font-mono);font-size:0.62rem;margin-top:0.4rem;padding:0;">â†© Reply</button>
                    <div id="reply-to-${c.id}" style="display:none;margin-top:0.5rem;display:none;">
                        <div style="display:flex;gap:0.4rem;flex-wrap:wrap;">
                            <input type="text" id="reply-name-${c.id}" placeholder="Name" style="flex:1;min-width:100px;font-size:0.8rem;padding:0.4rem 0.6rem;background:var(--bg-card);border:1px solid var(--border);color:var(--white);border-radius:var(--radius-sm);">
                            <input type="text" id="reply-text-${c.id}" placeholder="Reply..." style="flex:2;min-width:150px;font-size:0.8rem;padding:0.4rem 0.6rem;background:var(--bg-card);border:1px solid var(--border);color:var(--white);border-radius:var(--radius-sm);">
                            <button class="action-btn" style="font-size:0.68rem;padding:0.35rem 0.7rem;" onclick="addComment(${postId}, document.getElementById('reply-name-${c.id}').value, document.getElementById('reply-text-${c.id}').value, ${c.id})">Reply</button>
                        </div>
                    </div>` : ''}
                </div>`;
            }).join('');

            commentsHtml = `<div style="margin-top:1.5rem;border-top:1px solid var(--border);padding-top:1.25rem;">
                <h4 style="font-family:var(--font-heading);font-weight:600;font-size:0.95rem;margin-bottom:1rem;">ðŸ’¬ Comments (${comments.length})</h4>
                <div style="display:flex;flex-direction:column;gap:0.25rem;margin-bottom:1.25rem;">
                    ${commentItems}
                </div>
                <div style="background:var(--bg-elevated);padding:1rem;border-radius:var(--radius-sm);border:1px solid var(--border);">
                    <div style="font-family:var(--font-mono);font-size:0.68rem;color:var(--gray);margin-bottom:0.6rem;text-transform:uppercase;">Leave a comment</div>
                    <input type="text" id="comment-name-${postId}" placeholder="Your name" style="width:100%;font-size:0.88rem;padding:0.55rem 0.8rem;background:var(--bg-card);border:1px solid var(--border);color:var(--white);border-radius:var(--radius-sm);margin-bottom:0.5rem;box-sizing:border-box;">
                    <textarea id="comment-text-${postId}" placeholder="Write a comment..." rows="3" style="width:100%;font-size:0.88rem;padding:0.55rem 0.8rem;background:var(--bg-card);border:1px solid var(--border);color:var(--white);border-radius:var(--radius-sm);margin-bottom:0.5rem;resize:vertical;box-sizing:border-box;font-family:var(--font-body);"></textarea>
                    <button class="action-btn" style="font-size:0.78rem;padding:0.5rem 1.2rem;" onclick="addComment(${postId}, document.getElementById('comment-name-${postId}').value, document.getElementById('comment-text-${postId}').value)">Post Comment</button>
                </div>
            </div>`;
        }

        body.innerHTML = `
            ${mediaHtml}
            <div style="font-family:var(--font-mono);font-size:0.7rem;color:var(--gray);margin-bottom:0.5rem;">${escapeHtml(currentConfig.siteName)} Â· ${date}</div>
            <div style="font-size:1rem;line-height:1.8;margin-bottom:0.75rem;">${contentHtml}</div>
            ${tags ? `<div style="display:flex;gap:0.3rem;flex-wrap:wrap;margin-bottom:0.75rem;">${tags}</div>` : ''}
            ${currentConfig.reactionsEnabled ? `
            <div class="reaction-widget" style="margin-bottom:0.5rem;">
                <button class="reaction-btn like-btn ${myAction === 'like' ? 'voted' : ''}" onclick="reactTo(${postId},'like');openLightbox(${postId})">${lTxt} ${likes}</button>
                <div class="reaction-bar"><div class="reaction-fill" style="width:${ratio}%"></div></div>
                <button class="reaction-btn dislike-btn ${myAction === 'dislike' ? 'voted' : ''}" onclick="reactTo(${postId},'dislike');openLightbox(${postId})">${dTxt} ${dislikes}</button>
            </div>` : ''}
            <button class="btn-secondary" style="font-size:0.65rem;" onclick="copyPermalink(${postId})">Copy Link</button>
            ${commentsHtml}
        `;

        document.getElementById('leaflet-lightbox').style.display = 'flex';
        document.getElementById('leaflet-lightbox').classList.add('active');
        document.body.classList.add('modal-open');
    }

    function closeLightbox() {
        document.getElementById('leaflet-lightbox').classList.remove('active');
        document.getElementById('leaflet-lightbox').style.display = 'none';
        document.body.classList.remove('modal-open');
    }

    function copyPermalink(id) {
        const url = window.location.href.split('#')[0] + '#' + id;
        navigator.clipboard.writeText(url).then(() => showToast('Link copied!')).catch(() => showToast('Link: ' + url));
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       COMMENTS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    function addComment(postId, author, text, parentId = null) {
        if (!text || !text.trim()) { showToast('Write something first!', 'error'); return; }
        if (!author || !author.trim()) author = 'Anon';
        if (!interactionsCache[postId]) interactionsCache[postId] = { likes: 0, dislikes: 0, comments: [] };
        interactionsCache[postId].comments.push({
            id: Date.now(), author: author.trim(), text: text.trim(),
            date: new Date().toLocaleDateString() + ' ' + new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}),
            parentId: parentId || null
        });
        saveInteractionsLocal();
        openLightbox(postId);
        showToast('Comment posted!');
    }

    function deleteComment(postId, cid) {
        if (confirm('Delete this comment?')) {
            interactionsCache[postId].comments = interactionsCache[postId].comments.filter(c => c.id !== cid);
            openLightbox(postId);
            saveInteractionsLocal();
        }
    }

    function saveInteractionsLocal() {
        localStorage.setItem('NEERG_INTERACTIONS_BACKUP', JSON.stringify(interactionsCache));
        // Also sync to Neocities if we have a token
        saveInteractions();
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MEDIA VIEWER
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    let galleryMediaList = [];
    let galleryMediaIndex = -1;

    function buildGalleryMediaList() {
        galleryMediaList = [];
        const mediaPosts = postsCache.filter(p => p.media).sort((a,b) => b.id - a.id);
        mediaPosts.forEach(post => {
            let mediaArray = Array.isArray(post.media) ? post.media : [post.media];
            mediaArray.forEach(url => {
                galleryMediaList.push({ url: url, type: getMediaType(url) });
            });
        });
    }

    function openMediaViewer(url, type) {
        // Build list if empty
        if (galleryMediaList.length === 0) buildGalleryMediaList();
        // Find current index
        galleryMediaIndex = galleryMediaList.findIndex(m => m.url === url);

        const wrapper = document.getElementById('media-content-wrapper');
        if (type === 'video') wrapper.innerHTML = `<video controls autoplay loop style="max-width:95vw;max-height:95vh;"><source src="${url}"></video>`;
        else wrapper.innerHTML = `<img src="${url}" alt="Full size" style="max-width:95vw;max-height:95vh;object-fit:contain;">`;
        document.getElementById('media-fullscreen-overlay').style.display = 'flex';
        document.getElementById('media-fullscreen-overlay').classList.add('active');
        document.body.classList.add('modal-open');
        updateMediaCounter();
    }

    function closeMediaViewer() {
        document.getElementById('media-fullscreen-overlay').classList.remove('active');
        document.getElementById('media-fullscreen-overlay').style.display = 'none';
        document.body.classList.remove('modal-open');
        const wrapper = document.getElementById('media-content-wrapper');
        const vid = wrapper.querySelector('video');
        if (vid) vid.pause();
        wrapper.innerHTML = '';
        galleryMediaIndex = -1;
    }

    function mediaViewerNext() {
        if (galleryMediaList.length === 0) return;
        galleryMediaIndex = (galleryMediaIndex + 1) % galleryMediaList.length;
        showMediaAtIndex(galleryMediaIndex);
    }

    function mediaViewerPrev() {
        if (galleryMediaList.length === 0) return;
        galleryMediaIndex = (galleryMediaIndex - 1 + galleryMediaList.length) % galleryMediaList.length;
        showMediaAtIndex(galleryMediaIndex);
    }

    function showMediaAtIndex(idx) {
        const media = galleryMediaList[idx];
        if (!media) return;
        const wrapper = document.getElementById('media-content-wrapper');
        const oldVid = wrapper.querySelector('video');
        if (oldVid) oldVid.pause();
        if (media.type === 'video') wrapper.innerHTML = `<video controls autoplay loop style="max-width:95vw;max-height:95vh;"><source src="${media.url}"></video>`;
        else wrapper.innerHTML = `<img src="${media.url}" alt="Full size" style="max-width:95vw;max-height:95vh;object-fit:contain;">`;
        updateMediaCounter();
    }

    function updateMediaCounter() {
        const counter = document.getElementById('media-counter');
        if (counter && galleryMediaList.length > 1) {
            counter.textContent = (galleryMediaIndex + 1) + ' / ' + galleryMediaList.length;
            counter.style.display = 'block';
        } else if (counter) {
            counter.style.display = 'none';
        }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ADMIN AUTH
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    async function loginAdmin() {
        const passEl = document.getElementById('admin-pass');
        if (!globalAdminHash) { showToast('No config found â€” run setup first', 'error'); return; }

        const raw = passEl.value;
        let inputHash;
        if (globalSalt) {
            inputHash = await sha256(raw + globalSalt);
        } else {
            inputHash = await sha256(raw);
        }

        if (inputHash === globalAdminHash) {
            isAdminLoggedIn = true;
            sessionPassword = raw;

            // Auto-Migration: if we have a raw API key but no token, generate one
            if (globalApiKey && !globalAuthToken) {
                showToast("Upgrading Security...", "loading");
                const newToken = await requestTokenGeneration(globalApiKey, raw);
                if (newToken) {
                    globalAuthToken = newToken;
                    globalApiKey = null;
                    saveSystem();
                    showToast("Security Upgrade Complete!", "success");
                } else {
                    showToast("Security upgrade failed. Check bridge connection.", "error");
                }
            }

            document.getElementById('admin-login').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'block';
            populateAdminFields();
            renderLeaflets();
            showToast('Welcome back!');
        } else {
            showToast('Incorrect password', 'error');
        }
    }

    function logoutAdmin() {
        isAdminLoggedIn = false;
        sessionPassword = null;
        document.getElementById('admin-login').style.display = 'block';
        document.getElementById('admin-panel').style.display = 'none';
        document.getElementById('admin-pass').value = '';
        renderLeaflets();
        showToast('Logged out');
    }

    function populateAdminFields() {
        document.getElementById('settings-window-title').value = currentConfig.metaTitle || '';
        document.getElementById('settings-meta-desc').value = currentConfig.metaDescription || '';
        document.getElementById('settings-sitename').value = currentConfig.siteName || '';
        document.getElementById('settings-tagline').value = currentConfig.tagline || '';
        document.getElementById('settings-posts-tab').value = currentConfig.leafletsName || '';
        document.getElementById('settings-copyright').value = currentConfig.copyright || '';
        document.getElementById('settings-pfp').value = currentConfig.pfpImage || '';
        document.getElementById('settings-banner').value = currentConfig.bannerImage || '';
        document.getElementById('settings-about-text').value = currentConfig.aboutBio || localStorage.getItem('neerg_about_bio') || '';
        document.getElementById('settings-bg-image').value = currentConfig.bgImage || '';
        document.getElementById('settings-widget-padding').value = currentConfig.widgetPadding || '1.5rem';
        document.getElementById('settings-custom-css').value = currentConfig.customCss || '';
        document.getElementById('settings-reactions').value = String(currentConfig.reactionsEnabled);
        document.getElementById('settings-icon-style').value = currentConfig.reactionIcon || 'faces';
        document.getElementById('settings-like-label').value = currentConfig.likeLabel || '';
        document.getElementById('settings-dislike-label').value = currentConfig.dislikeLabel || '';
        document.getElementById('settings-comments').value = String(currentConfig.allowComments);

        const c = currentConfig.colors;
        document.getElementById('settings-bg').value = c.bg || '#0a0a0a';
        document.getElementById('settings-text').value = c.text || '#f0f0f0';
        document.getElementById('settings-sidebar').value = c.sidebar || '#111111';
        document.getElementById('settings-accent').value = c.accent || '#ff6b35';
        document.getElementById('settings-post-bg').value = c.leaflet || '#191515';
        document.getElementById('settings-borders').value = c.border || '#333333';
        document.getElementById('settings-nav-active').value = c.navActive || '#c8ff00';
        document.getElementById('settings-like-color').value = c.like || '#c8ff00';
        document.getElementById('settings-dislike-color').value = c.dislike || '#ff3c8e';
        document.getElementById('settings-like-btn').value = c.likeBtn || '#0a0a0a';
        document.getElementById('settings-dislike-btn').value = c.dislikeBtn || '#0a0a0a';
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       FILE UPLOAD HANDLER
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    let uploadedMediaDataURI = null;

    function handleFileUpload(input) {
        const file = input.files[0];
        if (!file) return;
        // Check size (warn if > 2MB for Neocities)
        if (file.size > 2 * 1024 * 1024) {
            showToast('Warning: Large files may not work well on Neocities. Consider using an image host.', 'error');
        }
        const reader = new FileReader();
        reader.onload = function(e) {
            uploadedMediaDataURI = e.target.result;
            const preview = document.getElementById('upload-preview');
            const previewImg = document.getElementById('upload-preview-img');
            if (file.type.startsWith('video/')) {
                preview.innerHTML = `<video src="${uploadedMediaDataURI}" style="max-width:200px;max-height:150px;border-radius:8px;border:1px solid var(--border);" muted loop playsinline></video>
                    <button type="button" onclick="clearUpload()" style="display:block;margin-top:0.3rem;font-family:var(--font-mono);font-size:0.65rem;color:var(--pink);background:none;border:none;cursor:pointer;">âœ• Remove</button>`;
            } else {
                previewImg.src = uploadedMediaDataURI;
                preview.style.display = 'block';
            }
            // Clear URL field since we're using upload
            document.getElementById('new-post-media-url').value = '';
        };
        reader.readAsDataURL(file);
    }

    function clearUpload() {
        uploadedMediaDataURI = null;
        document.getElementById('new-post-media-file').value = '';
        document.getElementById('upload-preview').style.display = 'none';
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       BRIDGE COMMUNICATION (LBM Secure Upload System)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    function injectBridge(url) {
        let frame = document.getElementById('bridge-frame');
        if (!frame) {
            frame = document.createElement('iframe');
            frame.id = 'bridge-frame';
            frame.style.cssText = 'width:1px;height:1px;opacity:0;position:absolute;pointer-events:none;';
            document.body.appendChild(frame);
        }
        frame.src = url;
    }

    // Token generation â€” encrypts the API key with the admin password via the bridge
    let tokenizeResolve = null;

    function requestTokenGeneration(key, pass) {
        return new Promise((resolve) => {
            tokenizeResolve = resolve;
            const frame = document.getElementById('bridge-frame');
            if (!frame) { resolve(null); return; }
            frame.contentWindow.postMessage({
                type: 'TOKENIZE',
                rawKey: key,
                adminPass: pass
            }, FIXED_BRIDGE_URL);
            // Timeout after 10 seconds
            setTimeout(() => { if (tokenizeResolve) { tokenizeResolve(null); } }, 10000);
        });
    }

    // Handle messages back from the bridge
    function handleBridgeMessage(e) {
        if (e.data.type === 'TOKEN_RESULT') {
            if (e.data.success && tokenizeResolve) {
                tokenizeResolve(e.data.token);
            } else if (!e.data.success && tokenizeResolve) {
                showToast("Token Generation Failed: " + e.data.message, "error");
                tokenizeResolve(null);
            }
            tokenizeResolve = null;
        }

        if (e.data.type === 'UPLOAD_RESULT') {
            if (currentLoadingToast && currentLoadingToast.parentNode) currentLoadingToast.remove();

            if (e.data.success) {
                showToast("âœ“ Synced! Everyone can see your changes now.", "success");
            } else {
                // Token rejected â€” show repair modal
                if (e.data.message && (e.data.message.includes("Invalid") || e.data.message.includes("403") || e.data.message.includes("invalid credentials"))) {
                    document.getElementById('repair-modal').style.display = 'flex';
                } else {
                    showToast("Sync failed: " + (e.data.message || "Unknown error"), "error");
                }
            }
        }
    }

    // Token Repair â€” re-authenticate when token is rejected
    async function runRepair() {
        const k = document.getElementById('repair-api-key').value;
        if (!k) { showToast("Please enter API Key", "error"); return; }

        showToast("Repairing Connection...", "loading");
        const newToken = await requestTokenGeneration(k.trim(), sessionPassword);

        if (newToken) {
            globalAuthToken = newToken;
            globalApiKey = null;
            document.getElementById('repair-modal').style.display = 'none';
            showToast("Repair Successful! Saving...", "success");
            setTimeout(() => saveSystem(), 1000);
        } else {
            showToast("Repair Failed. Check Key.", "error");
        }
    }

    // Upload file content to Neocities via the bridge
    function uploadToBridge(target, overrideToken) {
        const tokenToSend = overrideToken || globalAuthToken;
        if (!tokenToSend) {
            showToast("No Auth Token found. Run setup or repair.", "error");
            return;
        }

        // Only system uploads require the admin password check (matches original LBM)
        let passwordCheck = null;
        if (target === 'system') {
            if (!sessionPassword) {
                showToast("Session expired. Please re-login.", "error");
                return;
            }
            passwordCheck = sessionPassword;
        }

        let fileContent = "";
        let fileName = "";

        if (target === 'system') {
            const data = {
                adminHash: globalAdminHash,
                salt: globalSalt,
                siteConfig: currentConfig,
                posts: postsCache,
                authToken: tokenToSend,
                apiKey: null
            };
            fileContent = `window.AZUMINT_SYSTEM = "${unicodeToBase64(JSON.stringify(data))}";`;
            fileName = "system.js";
        } else if (target === 'interactions') {
            fileContent = `window.AZUMINT_INTERACTIONS = "${unicodeToBase64(JSON.stringify(interactionsCache))}";`;
            fileName = "interactions.js";
            showToast("Syncing interactions...", "loading");
        }

        const frame = document.getElementById('bridge-frame');
        if (frame && frame.contentWindow) {
            frame.contentWindow.postMessage({
                type: 'UPLOAD',
                authToken: tokenToSend,
                passwordCheck: passwordCheck,
                fileContent: fileContent,
                filename: fileName,
                mediaFile: null,
                mediaName: null
            }, FIXED_BRIDGE_URL);
        } else {
            showToast("Bridge disconnected. Try refreshing.", "error");
        }
    }

    // Main save function â€” uploads system.js to Neocities
    function saveSystem(overrideToken) {
        saveDataLocally();

        if (!globalAuthToken && !overrideToken && window.location.protocol === 'file:') {
            // Local mode â€” just download
            downloadSystemJS();
            showToast("Downloaded system.js (local mode)");
            return;
        }

        uploadToBridge('system', overrideToken);
    }

    // Save interactions to Neocities (matches original LBM)
    function saveInteractions() {
        if (!globalAuthToken && window.location.protocol === 'file:') return;
        uploadToBridge('interactions');
    }

    // Force sync everything
    function forceSyncAll() {
        saveDataLocally();
        uploadToBridge('system');
        setTimeout(() => uploadToBridge('interactions'), 2000);
        showToast("Force syncing all files...");
    }

    // Local backup (always runs as safety net)
    function saveDataLocally() {
        const data = { adminHash: globalAdminHash, salt: globalSalt, siteConfig: currentConfig, posts: postsCache, authToken: globalAuthToken };
        localStorage.setItem('NEERG_SYSTEM_BACKUP', JSON.stringify(data));
        localStorage.setItem('NEERG_INTERACTIONS_BACKUP', JSON.stringify(interactionsCache));
    }

    function loadLocalBackup() {
        try {
            const backup = localStorage.getItem('NEERG_SYSTEM_BACKUP');
            if (backup) {
                const data = JSON.parse(backup);
                if (data.posts && data.posts.length > postsCache.length) {
                    postsCache = data.posts;
                    if (data.siteConfig) currentConfig = { ...currentConfig, ...data.siteConfig, colors: { ...currentConfig.colors, ...(data.siteConfig.colors || {}) } };
                    if (data.adminHash) globalAdminHash = data.adminHash;
                    if (data.salt) globalSalt = data.salt;
                }
                if (data.authToken && !globalAuthToken) globalAuthToken = data.authToken;
            }
            // Interactions: server file (interactions.js) is always authoritative.
            // Only use localStorage backup for posts that DON'T exist in server data.
            const intBackup = localStorage.getItem('NEERG_INTERACTIONS_BACKUP');
            if (intBackup) {
                const intData = JSON.parse(intBackup);
                for (const key in intData) {
                    if (!interactionsCache[key]) {
                        interactionsCache[key] = intData[key];
                    }
                }
            }
        } catch(e) { console.log('No local backup found'); }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CREATE POST
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    function createPost() {
        const content = document.getElementById('new-post-content').value.trim();
        if (!content) { showToast('Write something first!', 'error'); return; }

        // Get media â€” prefer upload, fallback to URL
        let mediaUrl = uploadedMediaDataURI || document.getElementById('new-post-media-url').value.trim();

        // Get tags from clickable buttons
        const selectedTags = Array.from(document.querySelectorAll('#new-post-tags-bar .tag-toggle.selected')).map(btn => btn.dataset.tag);
        const customTag = (document.getElementById('new-post-custom-tag').value || '').trim();
        if (customTag) selectedTags.push(customTag);

        const pinned = document.getElementById('new-post-pinned').value === 'true';

        const newPost = {
            id: Date.now(),
            content: content,
            media: mediaUrl || null,
            tags: selectedTags,
            date: new Date().toLocaleDateString(),
            pinned: pinned
        };

        postsCache.push(newPost);
        interactionsCache[newPost.id] = { likes: 0, dislikes: 0, comments: [] };

        // Clear form
        document.getElementById('new-post-content').value = '';
        document.getElementById('new-post-media-url').value = '';
        document.getElementById('new-post-custom-tag').value = '';
        document.querySelectorAll('#new-post-tags-bar .tag-toggle').forEach(btn => btn.classList.remove('selected'));
        document.getElementById('new-post-pinned').value = 'false';
        clearUpload();

        currentPage = 1;
        renderLeaflets();
        renderGallery();
        populateArtScroll();

        // Auto-sync to Neocities
        saveSystem();
        showToast('Post created & syncing!');
    }

    function deletePost(postId) {
        if (!confirm('Delete this post permanently?')) return;
        postsCache = postsCache.filter(p => p.id !== postId);
        delete interactionsCache[postId];
        renderLeaflets();
        renderGallery();
        populateArtScroll();
        saveSystem();
        showToast('Post deleted & syncing.');
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MANAGE POSTS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    function renderManagePosts() {
        const list = document.getElementById('manage-posts-list');
        if (!list) return;
        if (postsCache.length === 0) { list.innerHTML = '<p style="color:var(--gray);font-family:var(--font-mono);font-size:0.8rem;">No posts to manage.</p>'; return; }
        list.innerHTML = [...postsCache].sort((a,b) => b.id - a.id).map(post => {
            const preview = (post.content || '').substring(0, 80) + ((post.content || '').length > 80 ? '...' : '');
            const date = post.date || new Date(post.id).toLocaleDateString();
            return `<div style="background:var(--bg-card);padding:1rem;border-radius:var(--radius-sm);border:1px solid var(--border);margin-bottom:0.5rem;display:flex;align-items:center;justify-content:space-between;gap:1rem;">
                <div style="flex:1;min-width:0;">
                    <div style="font-family:var(--font-mono);font-size:0.65rem;color:var(--gray);">${date} ${post.pinned ? 'ðŸ“Œ' : ''}</div>
                    <div style="font-size:0.85rem;color:var(--gray-light);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${escapeHtml(preview)}</div>
                </div>
                <div style="display:flex;gap:0.3rem;flex-shrink:0;">
                    <button class="btn-secondary" style="font-size:0.6rem;" onclick="togglePin(${post.id})">${post.pinned ? 'Unpin' : 'Pin'}</button>
                    <button class="btn-danger" style="font-size:0.6rem;" onclick="deletePost(${post.id});renderManagePosts()">Delete</button>
                </div>
            </div>`;
        }).join('');
    }

    function togglePin(postId) {
        const post = postsCache.find(p => p.id === postId);
        if (post) { post.pinned = !post.pinned; renderLeaflets(); renderManagePosts(); }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SAVE SETTINGS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    async function saveSettings() {
        currentConfig.metaTitle = document.getElementById('settings-window-title').value;
        currentConfig.metaDescription = document.getElementById('settings-meta-desc').value;
        currentConfig.siteName = document.getElementById('settings-sitename').value;
        currentConfig.tagline = document.getElementById('settings-tagline').value;
        currentConfig.leafletsName = document.getElementById('settings-posts-tab').value;
        currentConfig.copyright = document.getElementById('settings-copyright').value;
        currentConfig.pfpImage = document.getElementById('settings-pfp').value;
        currentConfig.bannerImage = document.getElementById('settings-banner').value;
        currentConfig.bgImage = document.getElementById('settings-bg-image').value;
        currentConfig.widgetPadding = document.getElementById('settings-widget-padding').value;
        currentConfig.customCss = document.getElementById('settings-custom-css').value;
        currentConfig.reactionsEnabled = document.getElementById('settings-reactions').value === 'true';
        currentConfig.reactionIcon = document.getElementById('settings-icon-style').value;
        currentConfig.likeLabel = document.getElementById('settings-like-label').value;
        currentConfig.dislikeLabel = document.getElementById('settings-dislike-label').value;
        currentConfig.allowComments = document.getElementById('settings-comments').value === 'true';

        currentConfig.colors.bg = document.getElementById('settings-bg').value;
        currentConfig.colors.text = document.getElementById('settings-text').value;
        currentConfig.colors.sidebar = document.getElementById('settings-sidebar').value;
        currentConfig.colors.accent = document.getElementById('settings-accent').value;
        currentConfig.colors.leaflet = document.getElementById('settings-post-bg').value;
        currentConfig.colors.border = document.getElementById('settings-borders').value;
        currentConfig.colors.navActive = document.getElementById('settings-nav-active').value;
        currentConfig.colors.like = document.getElementById('settings-like-color').value;
        currentConfig.colors.dislike = document.getElementById('settings-dislike-color').value;
        currentConfig.colors.likeBtn = document.getElementById('settings-like-btn').value;
        currentConfig.colors.dislikeBtn = document.getElementById('settings-dislike-btn').value;

        // Save about text to currentConfig (syncs to system.js)
        const aboutText = document.getElementById('settings-about-text').value.trim();
        currentConfig.aboutBio = aboutText;
        if (aboutText) localStorage.setItem('neerg_about_bio', aboutText);

        // Handle API key rotation
        const newKeyInput = document.getElementById('edit-neocities-key');
        if (newKeyInput && newKeyInput.value && newKeyInput.value.length > 5) {
            showToast("Rotating Security Token...");
            const newToken = await requestTokenGeneration(newKeyInput.value.trim(), sessionPassword);
            if (newToken) {
                globalAuthToken = newToken;
                newKeyInput.value = '';
                showToast("Token rotated successfully!", "success");
            } else {
                showToast("Token rotation failed. Check bridge.", "error");
            }
        }

        applyVisualConfig();
        renderLeaflets();
        saveSystem();
        showToast('Settings saved & syncing!');
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       GENERATE & DOWNLOAD SYSTEM FILES
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    async function generateSystem() {
        const password = document.getElementById('setup-password').value;
        const rawKey = document.getElementById('setup-neocities-key').value;
        if (password.length < 8) { showToast('Password must be at least 8 characters', 'error'); return; }
        if (!rawKey) { showToast('API Key is required for syncing', 'error'); return; }

        // Generate salt and hash
        const salt = Array.from(crypto.getRandomValues(new Uint8Array(16))).map(b => b.toString(16).padStart(2,'0')).join('');
        const hash = await sha256(password + salt);

        // Generate encrypted token via the bridge
        showToast("Encrypting credentials...");
        const token = await requestTokenGeneration(rawKey.trim(), password);
        if (!token) {
            showToast("Token generation failed. Make sure the page loaded fully, then try again.", "error");
            return;
        }

        // Read setup values
        currentConfig.siteName = document.getElementById('setup-sitename').value || 'MY ART BLOG';
        currentConfig.tagline = document.getElementById('setup-tagline').value || 'Digital Art Archive';
        currentConfig.leafletsName = document.getElementById('setup-posts-tab').value || 'Works';
        currentConfig.copyright = document.getElementById('setup-copyright').value || '2026 Artist Blog';
        currentConfig.pfpImage = document.getElementById('setup-pfp').value || '';
        currentConfig.bannerImage = document.getElementById('setup-banner').value || '';
        currentConfig.reactionsEnabled = document.getElementById('setup-reactions').value === 'true';
        currentConfig.reactionIcon = document.getElementById('setup-icon-style').value;
        currentConfig.likeLabel = document.getElementById('setup-like-label').value || 'Like';
        currentConfig.dislikeLabel = document.getElementById('setup-dislike-label').value || 'Dislike';
        currentConfig.widgetPadding = document.getElementById('setup-widget-padding').value || '1.5rem';
        currentConfig.bgImage = document.getElementById('setup-bg-image').value || '';
        currentConfig.allowComments = document.getElementById('setup-comments').value === 'true';
        currentConfig.customCss = document.getElementById('setup-custom-css').value || '';

        currentConfig.colors.bg = document.getElementById('setup-bg').value;
        currentConfig.colors.text = document.getElementById('setup-text').value;
        currentConfig.colors.sidebar = document.getElementById('setup-sidebar').value;
        currentConfig.colors.accent = document.getElementById('setup-accent').value;
        currentConfig.colors.leaflet = document.getElementById('setup-post-bg').value;
        currentConfig.colors.border = document.getElementById('setup-borders').value;
        currentConfig.colors.navActive = document.getElementById('setup-nav-active').value;
        currentConfig.colors.like = document.getElementById('setup-like-color').value;
        currentConfig.colors.dislike = document.getElementById('setup-dislike-color').value;
        currentConfig.colors.likeBtn = document.getElementById('setup-like-btn').value;
        currentConfig.colors.dislikeBtn = document.getElementById('setup-dislike-btn').value;

        globalAdminHash = hash;
        globalSalt = salt;
        globalAuthToken = token;
        sessionPassword = password;

        // Save locally first
        saveDataLocally();

        // Upload to Neocities via bridge
        uploadToBridge('system');

        hideSetup();
        applyVisualConfig();
        renderLeaflets();
        renderGallery();
        showToast('System configured & syncing to Neocities!');
    }

    function downloadSystemJS() {
        const data = { adminHash: globalAdminHash, salt: globalSalt, siteConfig: currentConfig, posts: postsCache, authToken: globalAuthToken };
        const content = `window.AZUMINT_SYSTEM = "${unicodeToBase64(JSON.stringify(data))}";`;
        downloadFile(content, 'system.js');
        showToast('system.js downloaded (backup).');
    }

    function downloadInteractionsJS() {
        const content = `window.AZUMINT_INTERACTIONS = "${unicodeToBase64(JSON.stringify(interactionsCache))}";`;
        downloadFile(content, 'interactions.js');
    }

    function downloadHTML() {
        const html = document.documentElement.outerHTML;
        downloadFile('<!DOCTYPE html>\n' + html, 'index.html');
        showToast('HTML downloaded!');
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       INITIALIZATION
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    document.addEventListener('DOMContentLoaded', () => {
        // Configure marked
        if (typeof marked !== 'undefined') {
            marked.setOptions({ breaks: true, gfm: true });
        }

        initScrollReveal();
        loadBannerSettings();
        loadSocialLinks();

        // Load saved theme
        const savedTheme = localStorage.getItem('neerg_theme');
        if (savedTheme === 'light') {
            isDarkMode = false;
            document.body.classList.add('light-mode');
            const toggleBtn = document.querySelector('.nav-icon-btn[title="Toggle theme"]');
            if (toggleBtn) toggleBtn.textContent = 'ðŸŒ™';
        }

        // Pill indicator
        requestAnimationFrame(updatePillIndicator);
        window.addEventListener('resize', () => requestAnimationFrame(updatePillIndicator));

        // Inject bridge iframe for Neocities API communication
        window.addEventListener('message', handleBridgeMessage);
        if (window.location.protocol !== 'file:') {
            injectBridge(FIXED_BRIDGE_URL);
        }

        // Load system data
        const timestamp = Date.now();
        const loadScript = (src) => new Promise((resolve) => {
            const s = document.createElement('script');
            s.src = `${src}?v=${timestamp}`;
            s.onload = resolve;
            s.onerror = () => { console.log(`[LBM] ${src} not found`); resolve(); };
            document.body.appendChild(s);
        });

        // Load system.js and interactions.js dynamically with cache-busting
        Promise.all([loadScript('system.js'), loadScript('interactions.js')]).then(() => {
            parseSystemData();
            // Merge any local backup data (in case user made changes but didn't re-upload system.js)
            loadLocalBackup();
            if (postsCache.length > 0) {
                renderLeaflets();
                renderGallery();
                populateArtScroll();
            }
        });

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeLightbox();
                closeMediaViewer();
            }
            // Arrow keys for media viewer
            const overlay = document.getElementById('media-fullscreen-overlay');
            if (overlay && overlay.classList.contains('active')) {
                if (e.key === 'ArrowRight' || e.key === 'ArrowDown') { e.preventDefault(); mediaViewerNext(); }
                if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') { e.preventDefault(); mediaViewerPrev(); }
            }
        });
    });

    </script>

</body>
</html>